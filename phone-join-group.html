<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Giri≈ü - Hesap Payla≈ü v2.3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 380px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo h1 {
            font-size: 28px;
            color: #667eea;
            font-weight: 700;
            margin: 0;
        }

        .logo p {
            font-size: 20px;
            color: #764ba2;
            font-weight: 600;
            margin: 5px 0 0 0;
        }

        .status-message {
            padding: 12px;
            border-radius: 10px;
            font-size: 13px;
            margin-bottom: 20px;
            display: none;
        }

        .status-message.success {
            background: #e8f5e9;
            color: #2e7d32;
            display: block;
        }

        .status-message.error {
            background: #ffebee;
            color: #c62828;
            display: block;
        }

        .status-message.info {
            background: #fff3e0;
            color: #e65100;
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .phone-wrapper {
            display: flex;
            gap: 8px;
        }

        .country-code {
            background: #f5f5f5;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 12px;
            width: 70px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"],
        input[type="email"],
        input[type="number"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .secondary-btn {
            background: #27ae60;
            margin-top: 10px;
        }

        .secondary-btn:hover:not(:disabled) {
            box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
        }

        .tertiary-btn {
            background: #3498db;
            margin-top: 10px;
        }

        .tertiary-btn:hover:not(:disabled) {
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease-out;
        }

        .modal.active {
            display: flex !important;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 380px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
            position: relative;
        }

        .modal-title {
            font-size: 20px;
            color: #333;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        .pin-inputs {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
        }

        .pin-input {
            width: 70px;
            height: 70px;
            border: 3px solid #ddd;
            border-radius: 12px;
            text-align: center;
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background: white;
            -webkit-appearance: none;
            appearance: none;
        }

        .pin-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2), 0 4px 12px rgba(102, 126, 234, 0.4);
            transform: scale(1.05);
            background: #f8faff;
        }

        .pin-input.filled {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.3);
        }

        .close-modal {
            background: #e74c3c;
            font-size: 14px;
            padding: 10px;
            margin-top: 10px;
        }

        .close-modal:hover {
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }

        .close-btn-top {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            transition: all 0.2s;
        }

        .close-btn-top:hover {
            background: #c0392b;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }

        .text-center {
            text-align: center;
            font-size: 14px;
            color: #666;
            margin-top: 15px;
        }

        .text-center a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .text-center a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="statusMessage" class="status-message"></div>

        <!-- Step 1: Phone Entry -->
        <div id="phoneSection">
            <div class="logo" style="background: linear-gradient(135deg, #e8f0ff 0%, #f5e8ff 100%); padding: 12px 15px; border-radius: 0; margin: -40px -40px 20px -40px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06); display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden;">
                <h1 style="font-size: 1.5em; margin: 0 0 -10px 0; letter-spacing: 0.5px; line-height: 1; display: flex; align-items: center; justify-content: center; gap: 6px;">
                    <span style="color: #4A90E2; font-weight: 900;">Hesap</span>
                    <span style="color: #27ae60; font-weight: 400; font-size: 1.2em;">%</span>
                    <span style="color: #9B59B6; font-weight: 900;">Payla≈ü</span>
                </h1>
                <p style="font-size: 1.1em; color: #666; font-style: italic; margin: 8px 0 0 0; font-family: 'Pacifico', 'Brush Script MT', 'Great Vibes', cursive; font-weight: 400; letter-spacing: 0.5px;">t√ºkettiƒüin kadar √∂de !</p>
            </div>

            <div class="form-group">
                <label>Telefon Numaranƒ±z</label>
                <div class="phone-wrapper">
                    <div class="country-code">+90</div>
                    <input 
                        type="text" 
                        id="phone" 
                        placeholder="(532) 313 32 77"
                        autocomplete="off"
                    />
                </div>
            </div>

            <button onclick="checkPhoneAndProceed()">ƒ∞leri</button>

            <div class="text-center" style="margin-top: 20px;">
                <p>Zaten hesabƒ±nƒ±z var mƒ±? üëã</p>
            </div>
        </div>
    </div>

    <!-- Modal for New User Registration -->
    <div id="newUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Yeni Hesap Olu≈ütur</div>
            <div id="newUserMessage" class="status-message"></div>

            <div class="form-group">
                <label>Adƒ±nƒ±z (ve Soyadƒ±nƒ±z)</label>
                <input 
                    type="text" 
                    id="userName" 
                    placeholder="√ñrn: Ahmet veya Ahmet Yƒ±lmaz"
                    autocomplete="off"
                />
            </div>

            <div class="form-group">
                <label>E-posta Adresiniz</label>
                <input 
                    type="email" 
                    id="userEmail" 
                    placeholder="√∂rnek@email.com"
                    autocomplete="off"
                />
            </div>

            <div class="form-group">
                <label>ƒ∞lk PIN Kodunuz (4 Rakam)</label>
                <div class="pin-inputs" id="newUserPinInputs">
                    <input class="pin-input" type="text" maxlength="1" autocomplete="off" />
                    <input class="pin-input" type="text" maxlength="1" autocomplete="off" />
                    <input class="pin-input" type="text" maxlength="1" autocomplete="off" />
                    <input class="pin-input" type="text" maxlength="1" autocomplete="off" />
                </div>
            </div>

            <button onclick="registerNewUser()">Hesap Olu≈ütur</button>
            <button class="close-modal" onclick="closeNewUserModal()">ƒ∞ptal</button>
        </div>
    </div>

    <!-- Modal for Existing User Login -->
    <div id="existingUserModal" class="modal">
        <div class="modal-content">
            <button class="close-btn-top" onclick="closeExistingUserModal()">√ó</button>
            <div class="modal-title">PIN Kodunuzu Girin</div>
            <div id="existingUserMessage" class="status-message"></div>

            <div style="margin: 30px 0;">
                <label style="text-align: center;">PIN Kodunuz (4 Rakam)</label>
                <div class="pin-inputs" id="pinInputs">
                    <input class="pin-input" type="password" maxlength="1" autocomplete="off" />
                    <input class="pin-input" type="password" maxlength="1" autocomplete="off" />
                    <input class="pin-input" type="password" maxlength="1" autocomplete="off" />
                    <input class="pin-input" type="password" maxlength="1" autocomplete="off" />
                </div>
            </div>

            <button onclick="loginWithPin()">Giri≈ü Yap</button>
            <button class="tertiary-btn" onclick="sendResetPinEmail()">PIN kodumu unuttum</button>
        </div>
    </div>

    <!-- Modal for PIN Reset -->
    <div id="pinResetModal" class="modal">
        <div class="modal-content">
            <button class="close-btn-top" onclick="closePinResetModal()">√ó</button>
            <div class="modal-title">Yeni PIN Kodunu Girin</div>
            <div id="resetMessage" class="status-message"></div>

            <div class="form-group" style="text-align: center; color: #666; font-size: 14px; margin-bottom: 20px;">
                <p>E-postanƒ±za g√∂nderilen kodu ve yeni PIN kodunuzu giriniz</p>
            </div>

            <div class="form-group">
                <label>Doƒürulama Kodu (E-postadan)</label>
                <input 
                    type="text" 
                    id="verificationCode" 
                    placeholder="6 haneli kodu girin"
                    autocomplete="off"
                    maxlength="6"
                />
            </div>

            <div class="form-group">
                <label>Yeni PIN Kodunuz (4 Rakam)</label>
                <div class="pin-inputs" id="newResetPinInputs">
                    <input class="pin-input" type="text" maxlength="1" autocomplete="off" />
                    <input class="pin-input" type="text" maxlength="1" autocomplete="off" />
                    <input class="pin-input" type="text" maxlength="1" autocomplete="off" />
                    <input class="pin-input" type="text" maxlength="1" autocomplete="off" />
                </div>
            </div>

            <button onclick="submitNewPin()">PIN Sƒ±fƒ±rla ve Giri≈ü Yap</button>
        </div>
    </div>

    <script>
        // ==================== CONSTANTS ====================
        const API_BASE = window.location.origin;
        const API_BASE_URL = API_BASE + '/api';
        const urlParams = new URLSearchParams(window.location.search);
        const groupCode = urlParams.get('code');

        // ==================== STATE ====================
        let currentPhone = '';
        let currentPin = '';
        let isNewUser = false;

        // ==================== UTILITIES ====================
        function showMessage(elementId, message, type = 'info') {
            const msgEl = document.getElementById(elementId);
            msgEl.textContent = message;
            msgEl.className = `status-message ${type}`;
        }

        function formatPhoneInput(value) {
            const digits = value.replace(/\D/g, '');
            if (digits.length === 0) return '';
            if (digits.length <= 3) return digits;
            if (digits.length <= 6) return `(${digits.slice(0, 3)}) ${digits.slice(3)}`;
            return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)} ${digits.slice(6, 8)} ${digits.slice(8, 10)}`;
        }

        function formatPhoneForAPI(phone) {
            return phone.replace(/\D/g, '');
        }

        // ==================== PHONE ENTRY ====================
        document.getElementById('phone').addEventListener('input', (e) => {
            e.target.value = formatPhoneInput(e.target.value);
        });

        async function checkPhoneAndProceed() {
            console.log('=== checkPhoneAndProceed STARTED ===');
            
            const phoneInput = document.getElementById('phone').value.trim();
            const phone = formatPhoneForAPI(phoneInput);
            const btn = document.querySelector('#phoneSection button');

            console.log('Raw input:', phoneInput);
            console.log('Formatted:', phone);

            if (phone.length !== 10) {
                showMessage('statusMessage', '‚ö†Ô∏è Telefon numarasƒ± 10 haneli olmalƒ±dƒ±r', 'error');
                return;
            }

            // Show loading state
            btn.disabled = true;
            btn.textContent = 'Kontrol ediliyor...';
            
            currentPhone = phone;

            try {
                const requestBody = { phone: phone };
                console.log('Sending request:', requestBody);
                console.log('API URL:', `${API_BASE_URL}/auth/check-phone`);
                
                // Add timeout
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await fetch(`${API_BASE_URL}/auth/check-phone`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });

                clearTimeout(timeout);
                console.log('Response status:', response.status);
                
                const data = await response.json();
                console.log('Response data:', data);

                if (!response.ok) {
                    btn.disabled = false;
                    btn.textContent = 'ƒ∞leri';
                    showMessage('statusMessage', '‚ùå Hata: ' + (data.error || 'Telefon kontrol√º ba≈üarƒ±sƒ±z'), 'error');
                    return;
                }

                // Decision logic
                console.log('Phone exists:', data.exists);
                console.log('typeof exists:', typeof data.exists);
                console.log('exists === true:', data.exists === true);
                console.log('exists === false:', data.exists === false);
                
                if (data.exists === true) {
                    console.log('ACTION: Opening EXISTING USER modal (PIN only)');
                    isNewUser = false;
                    openExistingUserModal();
                } else if (data.exists === false) {
                    console.log('ACTION: Opening NEW USER modal (Name + Email + PIN)');
                    isNewUser = true;
                    openNewUserModal();
                } else {
                    console.error('Unexpected exists value:', data.exists);
                    btn.disabled = false;
                    btn.textContent = 'ƒ∞leri';
                    showMessage('statusMessage', '‚ùå Beklenmeyen cevap', 'error');
                }
            } catch (error) {
                btn.disabled = false;
                btn.textContent = 'ƒ∞leri';
                console.error('Fetch error:', error);
                
                if (error.name === 'AbortError') {
                    showMessage('statusMessage', '‚ùå ƒ∞stek zaman a≈üƒ±mƒ±na uƒüradƒ±. L√ºtfen internet baƒülantƒ±nƒ±zƒ± kontrol edin.', 'error');
                } else {
                    showMessage('statusMessage', '‚ùå Baƒülantƒ± hatasƒ±: ' + error.message, 'error');
                }
            }
            
            console.log('=== checkPhoneAndProceed ENDED ===');
        }

        // ==================== NEW USER MODAL ====================
        function openNewUserModal() {
            console.log('Opening NEW USER modal...');
            try {
                // Close any other open modals first
                document.getElementById('existingUserModal')?.classList.remove('active');
                document.getElementById('pinResetModal')?.classList.remove('active');
                
                const modal = document.getElementById('newUserModal');
                if (!modal) {
                    console.error('Modal element not found: newUserModal');
                    return;
                }
                modal.classList.add('active');
                console.log('Modal classes:', modal.className);
                
                const nameInput = document.getElementById('userName');
                if (nameInput) {
                    setTimeout(() => nameInput.focus(), 100);
                }
                console.log('‚úÖ New user modal opened');
            } catch (e) {
                console.error('Error opening new user modal:', e);
            }
        }

        function closeNewUserModal() {
            console.log('Closing NEW USER modal...');
            try {
                document.getElementById('newUserModal').classList.remove('active');
                // Clear form fields
                document.getElementById('userName').value = '';
                document.getElementById('userEmail').value = '';
                document.querySelectorAll('#newUserPinInputs input').forEach(input => {
                    input.value = '';
                    input.classList.remove('filled');
                });
                currentPhone = '';
                currentPin = '';
                document.getElementById('phone').value = '';
                document.getElementById('phone').focus();
                console.log('‚úÖ Modal closed');
            } catch (e) {
                console.error('Error closing modal:', e);
            }
        }

        // ==================== EXISTING USER MODAL ====================
        function openExistingUserModal() {
            console.log('Opening EXISTING USER modal...');
            try {
                // Close any other open modals first
                document.getElementById('newUserModal')?.classList.remove('active');
                document.getElementById('pinResetModal')?.classList.remove('active');
                
                const modal = document.getElementById('existingUserModal');
                if (!modal) {
                    console.error('Modal element not found: existingUserModal');
                    return;
                }
                modal.classList.add('active');
                console.log('Modal classes:', modal.className);
                
                const firstPinInput = document.querySelector('#pinInputs input:first-child');
                if (firstPinInput) {
                    setTimeout(() => firstPinInput.focus(), 100);
                }
                console.log('‚úÖ Existing user modal opened');
            } catch (e) {
                console.error('Error opening existing user modal:', e);
            }
        }

        function closeExistingUserModal() {
            console.log('Closing EXISTING USER modal...');
            try {
                document.getElementById('existingUserModal').classList.remove('active');
                clearPinInputs();
                currentPhone = '';
                currentPin = '';
                document.getElementById('phone').value = '';
                document.getElementById('phone').focus();
                console.log('‚úÖ Modal closed');
            } catch (e) {
                console.error('Error closing modal:', e);
            }
        }

        async function registerNewUser() {
            console.log('Registering new user...');
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            
            // Collect PIN from the 4 separate boxes
            const pinInputs = document.querySelectorAll('#newUserPinInputs input');
            const pin = Array.from(pinInputs).map(input => input.value).join('').trim();

            console.log('Form data:', { name, email, pin_length: pin.length, currentPhone });

            if (!name || name.length < 2) {
                showMessage('newUserMessage', '‚ö†Ô∏è Adƒ±nƒ±z en az 2 karakter olmalƒ±dƒ±r', 'error');
                return;
            }

            if (!email || !email.includes('@')) {
                showMessage('newUserMessage', '‚ö†Ô∏è Ge√ßerli bir e-posta adresi girin', 'error');
                return;
            }

            if (pin.length !== 4 || !/^\d+$/.test(pin)) {
                showMessage('newUserMessage', '‚ö†Ô∏è PIN 4 haneli rakam olmalƒ±dƒ±r', 'error');
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Olu≈üturuluyor...';

            const requestBody = {
                phone: currentPhone,
                pin: pin,
                is_signup: true,
                first_name: name.split(' ')[0],
                last_name: name.includes(' ') ? name.split(' ').slice(1).join(' ') : '',
                email: email
            };
            
            console.log('Request body:', requestBody);

            try {
                const response = await fetch(`${API_BASE_URL}/auth/phone-pin-login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                
                console.log('Response status:', response.status);
                console.log('Response data:', data);

                if (response.ok) {
                    showMessage('newUserMessage', '‚úÖ Hesap olu≈üturuldu! Y√∂nlendiriliyor...', 'success');
                    localStorage.setItem('hesapPaylas_token', data.token);
                    localStorage.setItem('hesapPaylas_user', JSON.stringify(data.user));
                    localStorage.setItem('lastUsedLoginPage', 'v2');

                    setTimeout(() => {
                        if (groupCode) {
                            window.location.href = `index.html?joinGroup=${groupCode}`;
                        } else {
                            window.location.href = 'index.html';
                        }
                    }, 1500);
                } else {
                    const errorMsg = data.error || data.message || 'Hesap olu≈üturulamadƒ±';
                    console.error('API error:', errorMsg, data);
                    showMessage('newUserMessage', '‚ùå ' + errorMsg, 'error');
                    btn.disabled = false;
                    btn.textContent = 'Hesap Olu≈ütur';
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('newUserMessage', '‚ùå Bir hata olu≈ütu. L√ºtfen tekrar deneyin.', 'error');
                btn.disabled = false;
                btn.textContent = 'Hesap Olu≈ütur';
            }
        }

        // ==================== EXISTING USER MODAL ====================
        function openExistingUserModal() {
            document.getElementById('existingUserModal').classList.add('active');
            document.querySelector('#pinInputs input:first-child').focus();
        }

        function closeExistingUserModal() {
            document.getElementById('existingUserModal').classList.remove('active');
            clearPinInputs();
            currentPhone = '';
            currentPin = '';
            document.getElementById('phone').value = '';
            document.getElementById('phone').focus();
        }

        function clearPinInputs() {
            document.querySelectorAll('#pinInputs input').forEach(input => {
                input.value = '';
                input.classList.remove('filled');
            });
            currentPin = '';
        }

        // PIN input auto-advance
        document.addEventListener('DOMContentLoaded', () => {
            const pinInputs = document.querySelectorAll('#pinInputs input');
            pinInputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value.length === 1) {
                        e.target.classList.add('filled');
                        if (index < pinInputs.length - 1) {
                            pinInputs[index + 1].focus();
                        }
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        pinInputs[index - 1].focus();
                    }
                    if (e.key === 'Enter') {
                        loginWithPin();
                    }
                });
            });

            document.getElementById('phone').focus();

            // PIN input auto-advance for NEW USER registration
            const newUserPinInputs = document.querySelectorAll('#newUserPinInputs input');
            newUserPinInputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    // Only allow digits
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    
                    if (e.target.value.length === 1) {
                        e.target.classList.add('filled');
                        if (index < newUserPinInputs.length - 1) {
                            newUserPinInputs[index + 1].focus();
                        }
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        newUserPinInputs[index - 1].focus();
                    }
                    if (e.key === 'Enter') {
                        registerNewUser();
                    }
                });
            });

            // PIN input auto-advance for PIN RESET
            const newResetPinInputs = document.querySelectorAll('#newResetPinInputs input');
            newResetPinInputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    // Only allow digits
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    
                    if (e.target.value.length === 1) {
                        e.target.classList.add('filled');
                        if (index < newResetPinInputs.length - 1) {
                            newResetPinInputs[index + 1].focus();
                        }
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        newResetPinInputs[index - 1].focus();
                    }
                    if (e.key === 'Enter') {
                        submitNewPin();
                    }
                });
            });
        });

        async function loginWithPin() {
            const pinInputs = document.querySelectorAll('#pinInputs input');
            const pin = Array.from(pinInputs).map(input => input.value).join('');

            if (pin.length !== 4) {
                showMessage('existingUserMessage', '‚ö†Ô∏è PIN 4 haneli olmalƒ±dƒ±r', 'error');
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> ƒ∞≈üleniyor...';

            try {
                const response = await fetch(`${API_BASE_URL}/auth/phone-pin-login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: currentPhone,
                        pin: pin,
                        is_signup: false
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('existingUserMessage', '‚úÖ Ba≈üarƒ±yla giri≈ü yaptƒ±nƒ±z', 'success');
                    localStorage.setItem('hesapPaylas_token', data.token);
                    localStorage.setItem('hesapPaylas_user', JSON.stringify(data.user));
                    localStorage.setItem('lastUsedLoginPage', 'v2');

                    setTimeout(() => {
                        if (groupCode) {
                            window.location.href = `index.html?joinGroup=${groupCode}`;
                        } else {
                            window.location.href = 'index.html';
                        }
                    }, 1500);
                } else {
                    showMessage('existingUserMessage', '‚ùå Hatalƒ± PIN...tekrar deneyin ya da PIN\'inizi yenileyin', 'error');
                    clearPinInputs();
                    btn.disabled = false;
                    btn.textContent = 'Giri≈ü Yap';
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('existingUserMessage', '‚ùå Bir hata olu≈ütu. L√ºtfen tekrar deneyin.', 'error');
                btn.disabled = false;
                btn.textContent = 'Giri≈ü Yap';
            }
        }

        // ==================== PIN RESET ====================
        function showPinReset() {
            document.getElementById('existingUserModal').classList.remove('active');
            document.getElementById('pinResetModal').classList.add('active');
            document.getElementById('resetEmail').focus();
        }

        async function sendResetPinEmail() {
            if (!currentPhone) {
                showMessage('existingUserMessage', '‚ö†Ô∏è Telefon numarasƒ±nƒ± girmek gerekiyor', 'error');
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'G√∂nderiliyor...';

            try {
                const response = await fetch(`${API_BASE_URL}/auth/request-pin-reset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: currentPhone
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('existingUserMessage', '‚úÖ PIN sƒ±fƒ±rlama kodu e-postanƒ±za g√∂nderildi!', 'success');
                    setTimeout(() => {
                        // Show PIN reset modal for user to enter new PIN
                        document.getElementById('existingUserModal').classList.remove('active');
                        document.getElementById('pinResetModal').classList.add('active');
                        // Clear and focus on first PIN input box
                        document.querySelectorAll('#newResetPinInputs input').forEach(input => {
                            input.value = '';
                            input.classList.remove('filled');
                        });
                        document.querySelector('#newResetPinInputs input:first-child').focus();
                        document.getElementById('resetMessage').textContent = '';
                    }, 1500);
                } else {
                    showMessage('existingUserMessage', '‚ùå ' + (data.error || data.message || 'E-posta g√∂nderilemedi'), 'error');
                    btn.disabled = false;
                    btn.textContent = 'PIN kodumu unuttum';
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('existingUserMessage', '‚ùå Bir hata olu≈ütu. L√ºtfen tekrar deneyin.', 'error');
                btn.disabled = false;
                btn.textContent = 'PIN kodumu unuttum';
            }
        }

        function closePinResetModal() {
            document.getElementById('pinResetModal').classList.remove('active');
            // Clear form fields
            document.getElementById('verificationCode').value = '';
            document.querySelectorAll('#newResetPinInputs input').forEach(input => {
                input.value = '';
                input.classList.remove('filled');
            });
            document.getElementById('resetMessage').textContent = '';
            // Return to main login page
            clearPinInputs();
            currentPhone = '';
            currentPin = '';
            document.getElementById('phone').value = '';
            document.getElementById('phone').focus();
        }

        async function submitNewPin() {
            // Collect verification code
            const verificationCode = document.getElementById('verificationCode').value.trim();
            
            // Collect new PIN from the 4 separate boxes
            const newPinInputs = document.querySelectorAll('#newResetPinInputs input');
            const newPin = Array.from(newPinInputs).map(input => input.value).join('').trim();

            if (!verificationCode || verificationCode.length !== 6) {
                showMessage('resetMessage', '‚ö†Ô∏è Doƒürulama kodu 6 haneli olmalƒ±dƒ±r', 'error');
                return;
            }

            if (newPin.length !== 4 || !/^\d+$/.test(newPin)) {
                showMessage('resetMessage', '‚ö†Ô∏è PIN 4 haneli rakam olmalƒ±dƒ±r', 'error');
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Doƒürulanƒ±yor...';

            try {
                const response = await fetch(`${API_BASE_URL}/auth/reset-pin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: currentPhone,
                        verification_code: verificationCode,
                        new_pin: newPin
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('resetMessage', '‚úÖ PIN ba≈üarƒ±yla g√ºncellendi! Giri≈ü yapƒ±lƒ±yor...', 'success');
                    
                    // Auto-login after PIN reset
                    setTimeout(() => {
                        // Store token and user data
                        localStorage.setItem('hesapPaylas_token', data.token);
                        localStorage.setItem('hesapPaylas_user', JSON.stringify(data.user));
                        localStorage.setItem('lastUsedLoginPage', 'v2');
                        
                        // Redirect to home page
                        if (groupCode) {
                            window.location.href = `index.html?joinGroup=${groupCode}`;
                        } else {
                            window.location.href = 'index.html';
                        }
                    }, 1500);
                } else {
                    showMessage('resetMessage', '‚ùå ' + (data.error || 'Doƒürulama ba≈üarƒ±sƒ±z'), 'error');
                    btn.disabled = false;
                    btn.textContent = 'PIN Sƒ±fƒ±rla ve Giri≈ü Yap';
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('resetMessage', '‚ùå Bir hata olu≈ütu. L√ºtfen tekrar deneyin.', 'error');
                btn.disabled = false;
                btn.textContent = 'PIN Sƒ±fƒ±rla ve Giri≈ü Yap';
            }
        }
    </script>
</body>
</html>
