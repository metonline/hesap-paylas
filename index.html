<!DOCTYPE html>
<!--
    Hesap Payla≈ü - Bill Splitting App
    Version: 2.0.2
    Last Updated: 2026-01-13
    IMPORTANT: Service Worker will handle cache busting for script.js via query params
-->
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="theme-color" content="#FF6B6B">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Hesap Payla≈ü">
    <meta name="description" content="Hƒ±zlƒ± ve adil hesap b√∂l√º≈üt√ºrme uygulamasƒ±">
    <meta name="keywords" content="hesap, b√∂l√º≈üme, restoran, seyahat, payla≈üma">
    
    <title>Hesap Payla≈ü</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%23FF6B6B' width='192' height='192'/><text x='96' y='110' font-size='80' font-weight='bold' text-anchor='middle' fill='white' font-family='Arial'>HP</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%23FF6B6B' width='180' height='180' rx='40'/><text x='90' y='105' font-size='70' font-weight='bold' text-anchor='middle' fill='white' font-family='Arial'>HP</text></svg>">
    
    <link rel="stylesheet" href="styles.css?v=37">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <!-- DEBUG PANEL - TEMPORARY -->
    <style>
        #debugPanel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #f0f0f0;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 10px;
            font-size: 11px;
            font-family: monospace;
            max-width: 250px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 99999;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        #debugPanel div {
            margin: 3px 0;
            padding: 3px;
            background: white;
            border-radius: 3px;
        }
        #debugPanel .status-ok { color: green; font-weight: bold; }
        #debugPanel .status-error { color: red; font-weight: bold; }
        #debugPanel .status-info { color: blue; }
    </style>
    <style>
        * {
            -webkit-user-select: none;
            user-select: none;
        }
        input, textarea, select {
            -webkit-user-select: text;
            user-select: text;
        }
        
        /* Balon efekti animasyonu */
        @keyframes balloonFloat {
            0% {
                transform: translateY(0px) translateX(0px);
            }
            25% {
                transform: translateY(-15px) translateX(5px);
            }
            50% {
                transform: translateY(-25px) translateX(-8px);
            }
            75% {
                transform: translateY(-15px) translateX(3px);
            }
            100% {
                transform: translateY(0px) translateX(0px);
            }
        }
        
        #activeGroupToggle {
            animation: balloonFloat 4s ease-in-out infinite !important;
        }
    </style>
</head>
<body>
    <!-- PIN Reminder Code Modal -->
    <div id="resetCodeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; flex-direction: column; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 8px 30px rgba(0,0,0,0.3); text-align: center;">
            <h2 style="color: #333; margin-bottom: 10px; font-size: 1.5em;">PIN Hatƒ±rlatma Kodunuzu Doƒürulayƒ±n</h2>
            <p style="color: #666; margin-bottom: 25px; font-size: 0.95em;">E-posta aracƒ±lƒ±ƒüƒ±yla alƒ±nan 6 haneli kodu girin.</p>
            
            <!-- Step Counter -->
            <div style="display: flex; justify-content: center; gap: 8px; margin-bottom: 25px;">
                <div style="width: 30px; height: 30px; border-radius: 50%; background: #667eea; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">1</div>
                <div style="width: 30px; height: 30px; border-radius: 50%; background: #ddd; color: #999; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">2</div>
            </div>
            
            <!-- Code Input Fields -->
            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 25px; max-width: 300px; margin-left: auto; margin-right: auto;">
                <input class="reset-code-input" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #667eea; transition: all 0.3s ease;" autocomplete="off" />
                <input class="reset-code-input" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #667eea; transition: all 0.3s ease;" autocomplete="off" />
                <input class="reset-code-input" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #667eea; transition: all 0.3s ease;" autocomplete="off" />
                <input class="reset-code-input" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #667eea; transition: all 0.3s ease;" autocomplete="off" />
                <input class="reset-code-input" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #667eea; transition: all 0.3s ease;" autocomplete="off" />
                <input class="reset-code-input" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #667eea; transition: all 0.3s ease;" autocomplete="off" />
            </div>
            
            <!-- Status Message -->
            <div id="resetCodeMessage" style="margin-bottom: 20px; min-height: 30px;"></div>
            
            <!-- Buttons -->
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="closeResetCodeModal()" style="flex: 1; padding: 12px; background: #f0f0f0; color: #333; border: 1px solid #ddd; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">ƒ∞ptal</button>
                <button onclick="verifyResetCode()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">Doƒürula</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Onboarding/Kayƒ±t Sayfasƒ± -->
        <div id="onboardingPage" class="page active" style="background: white; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; overflow-y: auto;">
            <div class="onboarding-content">
                <div class="onboarding-header" style="background: linear-gradient(135deg, #e8f0ff 0%, #f5e8ff 100%); padding: 12px 15px; border-radius: 0; margin-bottom: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06); display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden;">
                    <h1 style="font-size: 1.5em; margin: 0 0 -10px 0; letter-spacing: 0.5px; line-height: 1; display: flex; align-items: center; justify-content: center; gap: 6px;">
                        <span style="color: #4A90E2; font-weight: 900;">Hesap</span>
                        <span style="color: #27ae60; font-weight: 400; font-size: 1.2em;">%</span>
                        <span style="color: #9B59B6; font-weight: 900;">Payla≈ü</span>
                    </h1>
                    <p style="font-size: 1.1em; color: #666; font-style: italic; margin: 8px 0 0 0; font-family: 'Pacifico', 'Brush Script MT', 'Great Vibes', cursive; font-weight: 400; letter-spacing: 0.5px;">t√ºkettiƒüin kadar √∂de !</p>
                </div>

                <div class="signup-section" style="max-width: 380px; margin: 0 auto;">
                    <!-- Phone PIN Login Form (Inline) -->
                    <div id="loginForm" class="auth-form login-card" style="padding: 0;">
                        <div class="login-header" style="margin: 20px 20px 20px 20px; text-align: center; color: white; font-size: 18px; font-weight: 600; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 14px; border-radius: 10px; line-height: 1.5;">Telefon No.su ile Giri≈ü</div>
                        
                        <!-- Unified Login Form Container -->
                        <div style="max-width: 340px; margin: 0 auto; padding: 0 20px;">
                        
                            <div id="statusMessageHome" class="status-message" style="margin-bottom: 15px; word-wrap: break-word; white-space: normal; line-height: 1.4; max-height: 4.2em; overflow: hidden;"></div>
                            
                            <!-- Phone Input Section -->
                            <div style="margin-bottom: 20px; display: flex; gap: 8px; align-items: center; min-width: 0;">
                                <div style="background: #f5f5f5; border: 2px solid #ddd; border-radius: 10px; padding: 12px; font-weight: 600; color: #333; display: flex; align-items: center; justify-content: center; height: 44px; width: 50px; flex-shrink: 0;">+90</div>
                                <input 
                                    type="text" 
                                    id="phoneHome" 
                                    placeholder="(5xx) 333 22 22"
                                    style="padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; transition: border-color 0.3s; height: 44px; flex: 1; box-sizing: border-box; min-width: 0;"
                                    autocomplete="off"
                                />
                            </div>
                            
                            <!-- PIN Input Section -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 12px; color: #333; font-weight: 600; font-size: 14px; text-align: center;">PIN Kodunuz (4 Rakam)</label>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                                    <input class="pin-input-home" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #667eea; transition: all 0.3s ease; box-shadow: 0 2px 6px rgba(0,0,0,0.1); background: white;" autocomplete="off" />
                                    <input class="pin-input-home" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #667eea; transition: all 0.3s ease; box-shadow: 0 2px 6px rgba(0,0,0,0.1); background: white;" autocomplete="off" />
                                    <input class="pin-input-home" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #667eea; transition: all 0.3s ease; box-shadow: 0 2px 6px rgba(0,0,0,0.1); background: white;" autocomplete="off" />
                                    <input class="pin-input-home" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #667eea; transition: all 0.3s ease; box-shadow: 0 2px 6px rgba(0,0,0,0.1); background: white;" autocomplete="off" />
                                </div>
                            </div>
                            
                            <!-- Name Input Section (for new users) -->
                            <div id="nameSection" style="margin-bottom: 20px; display: none;">
                                <input 
                                    type="text" 
                                    id="userName" 
                                    placeholder="Adƒ±nƒ±z (ve Soyadƒ±nƒ±z)"
                                    style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; transition: border-color 0.3s; height: 44px; box-sizing: border-box;"
                                    autocomplete="off"
                                />
                            </div>
                            
                            <!-- Email Input Section (for new users) -->
                            <div id="emailSection" style="margin-bottom: 20px; display: none;">
                                <input 
                                    type="email" 
                                    id="userEmail" 
                                    placeholder="E-posta Adresiniz"
                                    style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; transition: border-color 0.3s; height: 44px; box-sizing: border-box;"
                                    autocomplete="off"
                                />
                            </div>
                            
                            <!-- Login/Register Button -->
                            <button onclick="submitPhoneForm()" class="login-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-bottom: 12px; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; width: 100%; padding: 14px; box-sizing: border-box;">
                                <span id="buttonText">Giri≈ü Yap</span>
                            </button>
                            
                            <!-- PIN Reminder Quick Access Buttons -->
                            <button id="resetPinBtn" onclick="resetPinBothChannels()" style="padding: 14px; width: 100%; background: linear-gradient(135deg, #25D366 0%, #13b955 100%); color: white; border: none; border-radius: 10px; font-size: 1em; font-weight: 700; cursor: pointer; transition: all 0.3s; box-sizing: border-box;">üîë PIN Hatƒ±rlatma Kodu G√∂nder</button>
                        
                        </div>
                            <script>
                            async function resetPinBothChannels() {
                                console.log('[DEBUG] resetPinBothChannels called');
                                const user = app && app.currentUser ? app.currentUser : null;
                                console.log('[DEBUG] app.currentUser:', user);
                                let phone = user && user.phone ? user.phone : '';
                                // Ensure phone is formatted as +90XXXXXXXXXX
                                if (phone && !phone.startsWith('+')) {
                                    phone = '+90' + phone.replace(/^0+/, '');
                                }
                                const statusEl = document.getElementById('statusMessageHome');
                                if (!phone) {
                                    statusEl.textContent = 'Profilinizde kayƒ±tlƒ± telefon gereklidir. L√ºtfen profilinizi g√ºncelleyin.';
                                    statusEl.className = 'status-message error';
                                    statusEl.style.display = 'block';
                                    return;
                                }
                                try {
                                    const API_BASE = window.location.origin;
                                    const API_BASE_URL = API_BASE + '/api';
                                    const response = await fetch(`${API_BASE_URL}/auth/request-pin-reset-both`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ phone: phone })
                                    });
                                    const data = await response.json();
                                    if (response.ok) {
                                        let msg = '6 haneli doƒürulama kodu hem SMS hem e-posta ile g√∂nderildi!';
                                        if (data.sms_sent === false) msg += ' (SMS g√∂nderilemedi)';
                                        if (data.email_sent === false) msg += ' (E-posta g√∂nderilemedi)';
                                        statusEl.textContent = msg;
                                        statusEl.className = 'status-message success';
                                        statusEl.style.display = 'block';
                                    } else {
                                        let errMsg = '‚ùå ' + (data.message || data.error || 'Hata olu≈ütu');
                                        if (data.debug) errMsg += ' [Debug: ' + data.debug + ']';
                                        statusEl.textContent = errMsg;
                                        statusEl.className = 'status-message error';
                                        statusEl.style.display = 'block';
                                    }
                                } catch (error) {
                                    statusEl.textContent = '‚ùå Bir hata olu≈ütu. L√ºtfen tekrar deneyin.';
                                    statusEl.className = 'status-message error';
                                    statusEl.style.display = 'block';
                                }
                            }
                            </script>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ana Sayfa -->
        <div id="homePage" class="page">
            <div class="header" style="position: relative; background: linear-gradient(135deg, #e8f0ff 0%, #f5e8ff 100%); padding: 12px 15px; border-radius: 0; margin-bottom: 12px;">
                <!-- Hamburger Menu Butonu -->
                <button id="menuToggleBtn" class="menu-toggle-btn" onclick="toggleSideMenu()" title="Menu" style="position: absolute !important; top: 15px !important; left: 15px !important; background: white; border: none; border-radius: 8px; width: 40px; height: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s; z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; padding: 0;">
                    <span style="width: 20px; height: 2px; background: #333; transition: all 0.3s;"></span>
                    <span style="width: 20px; height: 2px; background: #333; transition: all 0.3s;"></span>
                    <span style="width: 20px; height: 2px; background: #333; transition: all 0.3s;"></span>
                </button>

                <!-- Profil ƒ∞konu -->
                <button id="homeProfileBtn" class="profile-btn" onclick="goToProfile()" title="Profil" style="position: absolute !important; top: 15px !important; right: 15px !important; left: auto !important; display: none; background: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s; z-index: 10; flex-shrink: 0;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#333" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </button>
                
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1; text-align: center;">
                        <h1 style="font-size: 1.5em; margin: 0 0 -10px 0; letter-spacing: 0.5px; line-height: 1; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <span class="hesap">Hesap</span>
                            <span style="color: #27ae60; font-weight: 400; font-size: 1.2em;">%</span>
                            <span class="paylas">Payla≈ü</span>
                        </h1>
                        <p style="font-size: 1.1em; color: #666; font-style: italic; margin: 8px 0 0 0; font-family: 'Pacifico', 'Brush Script MT', 'Great Vibes', cursive; font-weight: 400; letter-spacing: 0.5px;">t√ºkettiƒüin kadar √∂de !</p>
                    </div>
                </div>
                
                <!-- Ho≈ügeldin Mesajƒ± -->
                <div id="homeWelcomeMessage" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 8px; text-align: center;">
                    <p style="margin: 0; color: #333; font-weight: 600;">Ho≈ügeldin, <span id="homeUserName"></span>! üëã</p>
                </div>
            </div>
            </div>
            
            <!-- Login Olan Kullanƒ±cƒ±lar i√ßin Men√º -->
            <div id="homeUserMenu" style="display: none; padding: 20px;">
                <div style="display: grid; grid-template-columns: 1fr; gap: 15px; max-width: 400px; margin: 0 auto;">
                    <div class="option-card" onclick="checkUserAndNavigate()">
                        <div class="option-icon">üë•</div>
                        <h2>Grup Kur / Katƒ±l</h2>
                    </div>
                    
                    <div class="option-card" onclick="checkUserForReservation()">
                        <div class="option-icon">‚òéÔ∏è</div>
                        <h2>Kolay Rezervasyon</h2>
                    </div>
                </div>
                
                <!-- Geri Butonu - Gizlenmi≈ü -->
                <div style="text-align: center; margin-top: 30px; display: none !important;">
                    <button onclick="goToProfile()" style="padding: 10px 20px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 0.95em; color: #333;">‚Üê Geri</button>
                </div>
            </div>
        </div>

        <!-- Rezervasyon Sayfasƒ± -->
        <div id="reservationPage" class="page">
            <button onclick="backToHome()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.8em; cursor: pointer; color: #999; z-index: 10;" title="Kapat">√ó</button>
            <div class="standard-header">
                <h1>
                    <span class="hesap-word">Hesap</span>
                    <span class="percent-sign">%</span>
                    <span class="paylas-word">Payla≈ü</span>
                </h1>
                <p>t√ºkettiƒüin kadar √∂de !</p>
            </div>
            
            <div class="form-container" style="padding: 15px;">
                <h2 style="text-align: center; margin-bottom: 20px;">Se√ßiminizi yapƒ±n !</h2>
                
                <!-- T√ºr Se√ßimi Butonlarƒ± -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                    <button onclick="setReservationType('restaurant')" style="padding: 15px; background: linear-gradient(135deg, #FF6B6B 0%, #FF8787 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: 600; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                        <span style="font-size: 2em;">üçΩÔ∏è</span>
                        <span>Cafe / Restaurant</span>
                    </button>
                    <button onclick="setReservationType('hotel')" style="padding: 15px; background: linear-gradient(135deg, #4ECDC4 0%, #44B3AB 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: 600; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                        <span style="font-size: 2em;">üè®</span>
        <script>
        async function resetPinBothChannels() {
            console.log('[DEBUG] resetPinBothChannels called');
            // Get phone from login input
            var phoneInput = document.getElementById('phoneHome');
            var phone = phoneInput ? phoneInput.value.replace(/\D/g, '') : '';
            var statusEl = document.getElementById('statusMessageHome');
            if (!phone || phone.length < 10) {
                statusEl.textContent = 'L√ºtfen ge√ßerli bir telefon numarasƒ± girin.';
                statusEl.className = 'status-message error';
                statusEl.style.display = 'block';
                return;
            }
            // Always use last 10 digits for Turkish numbers
            if (phone.length > 10) phone = phone.slice(-10);
            
            try {
                const API_BASE = window.location.origin;
                const API_BASE_URL = API_BASE + '/api';
                const response = await fetch(`${API_BASE_URL}/auth/request-pin-reset-both`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone: phone })
                });
                const data = await response.json();
                if (response.ok) {
                    let msg = '‚úÖ 6 haneli doƒürulama kodu e-posta ile g√∂nderildi!';
                    statusEl.textContent = msg;
                    statusEl.className = 'status-message success';
                    statusEl.style.display = 'block';
                    
                    // Store phone for later verification
                    window.resetPhoneNumber = phone;
                    // Show reset code modal after 1 second
                    setTimeout(() => {
                        openResetCodeModal();
                    }, 1000);
                } else {
                    let errMsg = '‚ùå ' + (data.message || data.error || 'Hata olu≈ütu');
                    statusEl.textContent = errMsg;
                    statusEl.className = 'status-message error';
                    statusEl.style.display = 'block';
                }
            } catch (error) {
                statusEl.textContent = '‚ùå Bir hata olu≈ütu. L√ºtfen tekrar deneyin.';
                statusEl.className = 'status-message error';
                statusEl.style.display = 'block';
            }
        }
        
        // Reset Code Modal Functions
        function openResetCodeModal() {
            const modal = document.getElementById('resetCodeModal');
            modal.style.display = 'flex';
            // Clear previous inputs
            document.querySelectorAll('.reset-code-input').forEach(input => {
                input.value = '';
                input.style.borderColor = '#ddd';
            });
            document.getElementById('resetCodeMessage').textContent = '';
            // Focus first input
            document.querySelector('.reset-code-input').focus();
        }
        
        function closeResetCodeModal() {
            const modal = document.getElementById('resetCodeModal');
            modal.style.display = 'none';
        }
        
        async function verifyResetCode() {
            const inputs = document.querySelectorAll('.reset-code-input');
            const code = Array.from(inputs).map(input => input.value).join('');
            const messageEl = document.getElementById('resetCodeMessage');
            
            if (code.length !== 6) {
                messageEl.textContent = '‚ùå L√ºtfen 6 haneli kodu tam olarak girin.';
                messageEl.style.color = '#e74c3c';
                return;
            }
            
            try {
                const API_BASE = window.location.origin;
                const API_BASE_URL = API_BASE + '/api';
                const phone = window.resetPhoneNumber || '';
                
                const response = await fetch(`${API_BASE_URL}/auth/verify-pin-reset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone: phone, code: code })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    messageEl.textContent = '‚úÖ Kodunuz doƒürulandƒ±! PIN sƒ±fƒ±rlandƒ±.';
                    messageEl.style.color = '#27ae60';
                    
                    // Close modal after 2 seconds
                    setTimeout(() => {
                        closeResetCodeModal();
                        // Show success on login page
                        const statusEl = document.getElementById('statusMessageHome');
                        statusEl.textContent = '‚úÖ PIN ba≈üarƒ±yla sƒ±fƒ±rlandƒ±. Yeni PIN belirlemeyi unutmayƒ±n!';
                        statusEl.className = 'status-message success';
                        statusEl.style.display = 'block';
                    }, 2000);
                } else {
                    messageEl.textContent = '‚ùå ' + (data.error || 'Kod doƒürulama ba≈üarƒ±sƒ±z');
                    messageEl.style.color = '#e74c3c';
                    
                    // Highlight all inputs on error
                    inputs.forEach(input => {
                        input.style.borderColor = '#e74c3c';
                    });
                }
            } catch (error) {
                messageEl.textContent = '‚ùå Bir hata olu≈ütu. L√ºtfen tekrar deneyin.';
                messageEl.style.color = '#e74c3c';
            }
        }
        
        // Allow auto-focus to next input on digit entry
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('reset-code-input')) {
                if (e.target.value && e.target.value.match(/[0-9]/)) {
                    const next = e.target.nextElementSibling;
                    if (next) next.focus();
                }
            }
        });
        </script>
                </div>
            </div>
        </div>
            
        <!-- Harita Modal -->
            <div id="mapModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;">
                <div style="background: white; width: 100%; max-width: 500px; max-height: 90vh; border-radius: 12px; overflow: hidden; position: relative; display: flex; flex-direction: column;">
                    <div style="background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%); padding: 15px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                        <h3 style="margin: 0; color: white; font-size: 1.1em;">üó∫Ô∏è Konum Se√ß</h3>
                        <button onclick="closeMapModal()" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer;">√ó</button>
                    </div>
                    
                    <div id="mapContainer" style="width: 100%; padding: 20px; background: linear-gradient(135deg, #f0f7ff 0%, #e8f1ff 100%); flex-shrink: 0; text-align: center; color: #666;">
                        <p style="font-size: 2.5em; margin: 10px 0;">üó∫Ô∏è</p>
                        <p style="margin: 10px 0; font-weight: 600;">Mekan adresini a≈üaƒüƒ±ya yazƒ±nƒ±z</p>
                        <p style="margin: 5px 0; font-size: 0.9em; color: #999;">√ñrn: Kadƒ±k√∂y Belediyesi, ƒ∞stanbul</p>
                    </div>
                    
                    <div style="padding: 15px; overflow-y: auto; flex: 1;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">Konum (Adres)</label>
                        <input type="text" id="locationInput" placeholder="Mekan adresini giriniz..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 0.95em; box-sizing: border-box; margin-bottom: 12px;">
                    </div>
                    
                    <div style="padding: 15px; border-top: 1px solid #ddd; display: flex; gap: 10px; flex-shrink: 0;">
                        <button onclick="closeMapModal()" style="flex: 1; padding: 12px; background: #ccc; color: #333; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ƒ∞ptal</button>
                        <button onclick="confirmMapLocation()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #11a853 0%, #0d7e3a 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Onayla</button>
                    </div>
                </div>
            </div>            </div>        </div>
        
        <!-- Mekan Detay Sayfasƒ± -->
        <div id="venueDetailPage" class="page">
            <button onclick="showPage('reservationPage')" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.8em; cursor: pointer; color: #999; z-index: 10;" title="Kapat">√ó</button>
            <div class="standard-header">
                <h1>
                    <span class="hesap-word">Hesap</span>
                    <span class="percent-sign">%</span>
                    <span class="paylas-word">Payla≈ü</span>
                </h1>
                <p>t√ºkettiƒüin kadar √∂de !</p>
            </div>
            
            <div class="form-container" style="padding: 20px;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 id="venueDetailName" style="margin: 0 0 10px 0; color: #333; font-size: 1.8em;"></h2>
                    <p id="venueDetailAddress" style="margin: 0; color: #999; font-size: 1em;"></p>
                </div>
                
                <!-- 3 E≈üit Buton -->
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <!-- Telefon Butonu -->
                    <a id="venuePhoneButton" href="" style="text-decoration: none;">
                        <button style="width: 100%; padding: 18px; background: linear-gradient(135deg, #11a853 0%, #0d7e3a 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1em; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                            <span style="font-size: 1.3em;">üìû</span>
                            <span id="venuePhoneText">Telefon</span>
                        </button>
                    </a>
                    
                    <!-- E-Rezervasyon Butonu -->
                    <button onclick="handleEreservation()" style="width: 100%; padding: 18px; background: linear-gradient(135deg, #FF6B6B 0%, #FF8787 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1em; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        <span style="font-size: 1.3em;">üìß</span>
                        <span>E-Rezervasyon</span>
                    </button>
                    
                    <!-- Adrese Git Butonu -->
                    <button onclick="navigateToVenue()" style="width: 100%; padding: 18px; background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1em; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        <span style="font-size: 1.3em;">üó∫Ô∏è</span>
                        <span>Adrese Git!</span>
                    </button>
                </div>
                
                <!-- Ek Bilgiler (Opsiyonel) -->
                <div style="margin-top: 30px; padding: 20px; background: #f9f9f9; border-radius: 10px;">
                    <h3 style="margin: 0 0 15px 0; color: #333; font-size: 1.2em;">‚ÑπÔ∏è Bilgiler</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.2em;">üìç</span>
                            <span id="venueDetailDistance" style="color: #666;">Mesafe bilgisi</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.2em;">üè™</span>
                            <span id="venueDetailType" style="color: #666;">Mekan t√ºr√º</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bilgi Giri≈üi Sayfasƒ± -->
        <!-- Grup Se√ßimi Sayfasƒ± -->
        <div id="groupChoicePage" class="page">
            <div class="standard-header">
                <h1>
                    <span class="hesap-word">Hesap</span>
                    <span class="percent-sign">%</span>
                    <span class="paylas-word">Payla≈ü</span>
                </h1>
                <p>t√ºkettiƒüin kadar √∂de !</p>
            </div>
            
            <div class="options-grid" style="margin-top: 20px; display: grid; grid-template-columns: 1fr; gap: 15px;">
                <div class="option-card" onclick="openCreateGroupModal()" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                    <div class="option-icon">‚ûï</div>
                    <h2>Grup Kur</h2>
                </div>
                
                <div class="option-card" onclick="openJoinGroupModal()" style="background: linear-gradient(135deg, #11a853 0%, #0d7e3a 100%);">
                    <div class="option-icon">üîó</div>
                    <h2>Gruba Katƒ±l</h2>
                </div>
            </div>
        </div>

        <!-- Grup Kodu Giri≈ü Sayfasƒ± -->
        <div id="joinCodePage" class="page" style="background: linear-gradient(135deg, #f5f0f9 0%, #faf8fc 100%);">
            <div class="standard-header">
                <h1>
                    <span class="hesap-word">Hesap</span>
                    <span class="percent-sign">%</span>
                    <span class="paylas-word">Payla≈ü</span>
                </h1>
                <p>t√ºkettiƒüin kadar √∂de !</p>
            </div>
            <button onclick="backToGroupChoice()" style="position: absolute; top: 75px; right: 15px; background: none; border: none; font-size: 28px; cursor: pointer; color: #7c3aed; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">‚úï</button>
            
            <div class="form-container" style="text-align: center; padding: 15px;">
                
                <div style="display: flex; gap: 8px; margin-bottom: 20px;">
                    <button onclick="showPage('qrScannerPage'); setTimeout(() => startQRScanner(), 100);" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #11a853 0%, #0d7e3a 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95em;">üé• Kamerayƒ± A√ß</button>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; text-align: left; margin-bottom: 8px; font-weight: 600; color: #333;">Grup Kodunu Yazƒ±nƒ±z</label>
                    <input type="text" id="joinGroupCode" placeholder="xxx-xxx" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; font-family: monospace; letter-spacing: 2px; box-sizing: border-box;">
                </div>
                
                <button onclick="submitJoinCode()" style="width: 100%; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em; margin-bottom: 15px;">Devam Et</button>
                
                <div id="joinCodeResult"></div>
            </div>
        </div>

        <!-- QR Kod Okuyucu Sayfasƒ± -->
        <div id="qrScannerPage" class="page">
            <div class="standard-header">
                <h1>
                    <span class="hesap-word">Hesap</span>
                    <span class="percent-sign">%</span>
                    <span class="paylas-word">Payla≈ü</span>
                </h1>
                <p>t√ºkettiƒüin kadar √∂de !</p>
            </div>
            <div class="back-button" onclick="backToJoinCodePage()">‚Üê Geri</div>
            
            <div class="form-container" style="text-align: center; padding: 15px;">
                <h2 style="margin-bottom: 20px;">QR Kod Okut</h2>
                
                <div style="position: relative; width: 100%; max-width: 300px; margin: 0 auto; background: #000; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    <video id="qrVideo" style="width: 100%; height: 300px; display: block;"></video>
                    <canvas id="qrCanvas" style="display: none;"></canvas>
                </div>
                
                <div id="qrResult" style="margin-top: 20px; min-height: 40px;">
                    <p style="color: #999; font-size: 0.9em;">Kamerayƒ± grup kodunun √ºzerine getir...</p>
                </div>
                
                <button onclick="stopQRScanner()" style="margin-top: 20px; padding: 12px 20px; background: #e0e0e0; border: none; border-radius: 8px; cursor: pointer; font-size: 1em;">Kamerayƒ± Kapat</button>
            </div>
        </div>

        <!-- Grup Kodu Sayfasƒ± -->
        <div id="groupCodePage" class="page" style="background: linear-gradient(135deg, #f5f0f9 0%, #faf8fc 100%); min-height: 100vh;">
            <div class="standard-header">
                <h1>
                    <span class="hesap-word">Hesap</span>
                    <span class="percent-sign">%</span>
                    <span class="paylas-word">Payla≈ü</span>
                </h1>
                <p>t√ºkettiƒüin kadar √∂de !</p>
            </div>
            
            <div class="form-container" style="text-align: center; padding: 8px 15px;">
                <h3 style="font-size: 1.3em; margin: 5px 0 15px 0; font-weight: 600; color: #333;">Grup Adƒ±nƒ±z : <span id="groupWelcomeTitle"></span></h3>
                
                <!-- QR Kodu Container - Sabitlenmi≈ü Geni≈ülik, Kompakt -->
                <div style="margin: 0 auto 15px auto; width: fit-content;">
                    <div id="qrCodeContainer" style="display: inline-block; padding: 8px; background: white; border-radius: 8px; border: 2px solid #f0f0f0;"></div>
                </div>
                
                <!-- 2 S√ºtunlu Grid: Kod Card ve Payla≈ü Butonu (QR kodun geni≈üliƒüine uygun) -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 0 auto 15px; width: fit-content;">
                    <!-- Kod Output Card -->
                    <div style="background: linear-gradient(135deg, #d4e8f7 0%, #e8f4fb 100%); padding: 12px 10px; border-radius: 8px; border: 2px solid #3498db; box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2); min-width: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <p id="groupCodeDisplay" style="font-size: 1.4em; color: #333; font-weight: bold; letter-spacing: 2px; font-family: monospace; margin: 0; text-align: center;"></p>
                    </div>
                    
                    <!-- Payla≈ü Butonu -->
                    <div style="display: flex; flex-direction: column; justify-content: center;">
                        <button onclick="smartShareGroup()" style="padding: 12px 10px; font-size: 0.95em; background: linear-gradient(135deg, #11a853 0%, #0d7e3a 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(17, 168, 83, 0.3); transition: all 0.3s; height: 100%; display: flex; align-items: center; justify-content: center;">üí¨ WhatsApp</button>
                    </div>
                </div>
                
                <p style="color: #666; margin: 0 0 15px 0; font-size: 0.75em; line-height: 1.3; text-align: center;">QR kodu ve Grup Kodunu kamera ile okutarak veya Payla≈ü butonu ile g√∂ndererek arkada≈ülarƒ±nƒ±zƒ± gruba dahil edebilirsiniz.</p>
                
                <div class="back-button" onclick="backToHome()" style="margin: 0 auto; width: fit-content;">‚Üê Geri</div>
            </div>
        </div>

        <!-- Payla≈üma Se√ßenekleri Modal -->
        <div id="shareModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: white; border-radius: 12px; padding: 25px; width: 90%; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                <p style="text-align: center; font-size: 1.1em; color: #666; font-style: italic; margin: 8px 0 15px 0; font-family: 'Pacifico', 'Brush Script MT', 'Great Vibes', cursive; font-weight: 400;">t√ºkettiƒüin kadar √∂de !</p>
                <h3 style="margin-top: 0; margin-bottom: 20px; text-align: center;">Gruba Davet Et</h3>
                
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="share-option" onclick="shareViaWhatsApp()" style="padding: 15px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 1em; text-align: left;">
                        üí¨ WhatsApp'ta Payla≈ü
                    </button>
                    <button class="share-option" onclick="shareViaSMS()" style="padding: 15px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 1em; text-align: left;">
                        üì± SMS ile G√∂nder
                    </button>
                    <button class="share-option" onclick="copyGroupCode()" style="padding: 15px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 1em; text-align: left;">
                        üìã Kodu Kopyala
                    </button>
                </div>
                
                <button onclick="closeShareModal()" style="width: 100%; padding: 12px; margin-top: 15px; background: #e0e0e0; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95em;">Kapat</button>
            </div>
        </div>

        <div id="infoPage" class="page">
            <div class="standard-header">
                <h1>
                    <span class="hesap-word">Hesap</span>
                    <span class="percent-sign">%</span>
                    <span class="paylas-word">Payla≈ü</span>
                </h1>
                <p>t√ºkettiƒüin kadar √∂de !</p>
            </div>
            <div class="back-button" onclick="backToHome()">‚Üê Geri</div>
            
            <div class="logo-card" style="margin: 20px 15px;">
                <h1 style="font-size: 2em; margin: 0 0 8px 0; letter-spacing: 0.5px;">
                    <span style="color: #4A90E2; font-weight: 900;">Hesap</span>
                    <span style="color: #999; font-weight: 400; font-size: 1.2em; margin: 0 8px;">/</span>
                    <span style="color: #9B59B6; font-weight: 900;">Payla≈ü</span>
                </h1>
                <p style="font-size: 0.95em; color: #666; font-style: italic; margin: 12px 0 0 0; font-family: 'Great Vibes', cursive;">hem √ßok kolay, hem √ßok adil !</p>
            </div>
            
            <div class="form-container">
                <h2 id="infoTitle">Bilgilerinizi Girin</h2>
                
                <div class="form-group">
                    <label for="infoFirstName">Adƒ±:</label>
                    <input type="text" id="infoFirstName" placeholder="√ñrn: Ahmet" autocomplete="off">
                </div>
                
                <div class="form-group">
                    <label for="infoLastName">Soyadƒ±:</label>
                    <input type="text" id="infoLastName" placeholder="√ñrn: Yƒ±lmaz" autocomplete="off">
                </div>
                
                <div class="form-group" id="groupIdGroup" style="display: none;">
                    <label for="groupId">Grup ID (ƒ∞steƒüe baƒülƒ±):</label>
                    <input type="text" id="groupId" placeholder="QR koddan group ID" autocomplete="off">
                </div>
                
                <button class="btn btn-primary" onclick="submitInfo()">Devam Et</button>
            </div>
        </div>

        <!-- Restaurant Se√ßimi -->
        <div id="restaurantPage" class="page">
            <div class="standard-header">
                <h1>
                    <span class="hesap-word">Hesap</span>
                    <span class="percent-sign">%</span>
                    <span class="paylas-word">Payla≈ü</span>
                </h1>
                <p>t√ºkettiƒüin kadar √∂de !</p>
            </div>
            <div class="back-button" onclick="backToInfo()">‚Üê Geri</div>
            
            <div class="logo-card" style="margin: 20px 15px;">
                <h1 style="font-size: 2em; margin: 0 0 8px 0; letter-spacing: 0.5px;">
                    <span style="color: #4A90E2; font-weight: 900;">Hesap</span>
                    <span style="color: #999; font-weight: 400; font-size: 1.2em; margin: 0 8px;">/</span>
                    <span style="color: #9B59B6; font-weight: 900;">Payla≈ü</span>
                </h1>
                <p style="font-size: 0.95em; color: #666; font-style: italic; margin: 12px 0 0 0; font-family: 'Great Vibes', cursive;">hem √ßok kolay, hem √ßok adil !</p>
            </div>
            
            <div class="section">
                <h2>üçΩÔ∏è Restaurant Se√ß</h2>
                <div id="restaurantList" class="restaurant-grid"></div>
            </div>
        </div>

        <!-- Sidebar Men√º -->
        <div id="sideMenu" class="side-menu" style="position: fixed; top: 0; left: -280px; width: 280px; height: 100vh; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 9998; transition: left 0.3s ease; overflow-y: auto;">
            <div style="padding: 20px 15px;">
                <button onclick="toggleSideMenu()" style="float: right; background: none; border: none; font-size: 24px; cursor: pointer; color: #333;">√ó</button>
                <h3 style="margin: 0 0 20px 0; clear: both; color: #333; font-size: 1.2em;">Men√º</h3>
                
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button onclick="navigateToMenu('groups')" class="menu-item" style="padding: 8px 10px; background: #f0f0f0; border: none; border-radius: 8px; text-align: left; cursor: pointer; font-size: 0.9em; transition: all 0.3s; line-height: 1.3;">
                        üë• Gruplarƒ±m
                    </button>
                    <button onclick="navigateToMenu('reservations')" class="menu-item" style="padding: 8px 10px; background: #f0f0f0; border: none; border-radius: 8px; text-align: left; cursor: pointer; font-size: 0.9em; transition: all 0.3s; line-height: 1.3;">
                        üìÖ Rezervasyonlarƒ±m
                    </button>
                    <button onclick="navigateToMenu('orders')" class="menu-item" style="padding: 8px 10px; background: #f0f0f0; border: none; border-radius: 8px; text-align: left; cursor: pointer; font-size: 0.9em; transition: all 0.3s; line-height: 1.3;">
                        üõí Sipari≈ülerim
                    </button>
                    <button onclick="navigateToMenu('favorites')" class="menu-item" style="padding: 8px 10px; background: #f0f0f0; border: none; border-radius: 8px; text-align: left; cursor: pointer; font-size: 0.9em; transition: all 0.3s; line-height: 1.3;">
                        ‚≠ê Favori Yerlerim
                    </button>
                    <button onclick="navigateToMenu('coupons')" class="menu-item" style="padding: 8px 10px; background: #f0f0f0; border: none; border-radius: 8px; text-align: left; cursor: pointer; font-size: 0.9em; transition: all 0.3s; line-height: 1.3;">
                        üéüÔ∏è Kuponlarƒ±m
                    </button>
                    <button onclick="navigateToMenu('rewards')" class="menu-item" style="padding: 8px 10px; background: #f0f0f0; border: none; border-radius: 8px; text-align: left; cursor: pointer; font-size: 0.9em; transition: all 0.3s; line-height: 1.3;">
                        üèÜ √ñd√ºl Puanlarƒ±m
                    </button>
                </div>
                
                <!-- Profil ve √áƒ±kƒ±≈ü Se√ßenekleri -->
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0; display: flex; flex-direction: column; gap: 8px;">
                    <button onclick="toggleSideMenu(); goToProfile();" class="menu-item" style="padding: 8px 10px; background: #667eea; color: white; border: none; border-radius: 8px; text-align: left; cursor: pointer; font-size: 0.9em; transition: all 0.3s; line-height: 1.3;">
                        üë§ Profil
                    </button>
                    <button onclick="toggleSideMenu(); logout();" class="menu-item" style="padding: 8px 10px; background: #e74c3c; color: white; border: none; border-radius: 8px; text-align: left; cursor: pointer; font-size: 0.9em; transition: all 0.3s; line-height: 1.3;">
                        üö™ √áƒ±kƒ±≈ü Yap
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar Overlay -->
        <div id="sideMenuOverlay" onclick="toggleSideMenu()" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0); z-index: 9997; transition: background 0.3s; display: none;"></div>

        <!-- Profil Sayfasƒ± - Modal -->
        <div id="profilePage" class="profile-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: none; align-items: center; justify-content: center;">
            <div style="position: relative; background: white; border-radius: 20px; max-width: 450px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); padding: 25px;">
            <button onclick="closeProfileModal()" style="position: absolute; top: 15px; right: 15px; background: #f0f0f0; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 24px; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; line-height: 1;">√ó</button>
            
            <h2 style="margin: 0 0 20px 0; color: #333; font-size: 1.5em; text-align: center;">üë§ Profil</h2>
            
            <div style="background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #e0e0e0;">
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; flex-direction: column; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                        <span style="color: #666; font-size: 0.85em; margin-bottom: 6px; font-weight: 500;">Ad Soyad</span>
                        <input type="text" id="profileNameEdit" placeholder="Adƒ±nƒ±z" style="border: 1px solid #ddd; border-radius: 6px; padding: 10px 12px; font-size: 0.95em; width: 100%; font-weight: 600; text-align: left; box-sizing: border-box;">
                    </div>
                    <div style="display: flex; flex-direction: column; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                        <span style="color: #666; font-size: 0.85em; margin-bottom: 6px; font-weight: 500;">üìß E-posta</span>
                        <input type="email" id="profileEmailEdit" placeholder="ƒ∞steƒüe baƒülƒ±" style="border: 1px solid #ddd; border-radius: 6px; padding: 10px 12px; font-size: 0.95em; width: 100%; font-weight: 600; text-align: left; box-sizing: border-box;">
                    </div>
                    <div style="display: flex; flex-direction: column; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                        <span style="color: #666; font-size: 0.85em; margin-bottom: 6px; font-weight: 500;">üì± Telefon</span>
                        <input type="text" id="profilePhoneEdit" placeholder="+90 (5xx) xxx xx xx" autocomplete="off" style="border: 1px solid #ddd; border-radius: 6px; padding: 10px 12px; font-size: 0.95em; width: 100%; font-weight: 600; text-align: left; box-sizing: border-box;">
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <button onclick="saveProfile()" style="padding: 12px; background: #27ae60; color: white; border: none; border-radius: 10px; font-size: 0.85em; font-weight: 600; cursor: pointer;">
                    üíæ Kaydet
                </button>
                <button onclick="showPinChangeInProfile()" style="padding: 12px; background: #f5576c; color: white; border: none; border-radius: 10px; font-size: 0.85em; font-weight: 600; cursor: pointer;">
                    üîê PIN Deƒüi≈ütir
                </button>
            </div>
            </div>
        </div>

        <!-- Simple PIN Change in Profile -->
        <div id="pinChangeInProfile" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
            <div style="position: relative; background: white; border-radius: 20px; max-width: 350px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); padding: 25px;">
                <button onclick="closePinChangeInProfile()" style="position: absolute; top: 15px; right: 15px; background: #f0f0f0; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 24px; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center;">√ó</button>
                
                <h2 style="margin: 0 0 20px 0; color: #333; font-size: 1.3em; text-align: center;">üîê Yeni PIN</h2>
                
                <div style="margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                        <input class="pin-profile-change" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #27ae60; transition: all 0.3s; box-shadow: 0 2px 6px rgba(0,0,0,0.1);" autocomplete="off" />
                        <input class="pin-profile-change" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #27ae60; transition: all 0.3s; box-shadow: 0 2px 6px rgba(0,0,0,0.1);" autocomplete="off" />
                        <input class="pin-profile-change" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #27ae60; transition: all 0.3s; box-shadow: 0 2px 6px rgba(0,0,0,0.1);" autocomplete="off" />
                        <input class="pin-profile-change" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #27ae60; transition: all 0.3s; box-shadow: 0 2px 6px rgba(0,0,0,0.1);" autocomplete="off" />
                    </div>
                </div>
                
                <div id="pinChangeProfileMsg" style="display: none; margin-bottom: 15px; padding: 10px; border-radius: 8px; text-align: center; font-weight: 600; font-size: 0.9em;"></div>
                
                <button onclick="savePinFromProfile()" style="width: 100%; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 10px; font-size: 0.95em; font-weight: 600; cursor: pointer;">
                    ‚úì PIN'i Kaydet
                </button>
            </div>
        </div>

        <!-- Forgot PIN Modal 1: Request Reset -->
        <div id="forgotPinModal" class="profile-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: none; align-items: center; justify-content: center;">
            <div style="position: relative; background: white; border-radius: 20px; max-width: 400px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); padding: 25px;">
                <button onclick="closeForgotPinModal()" style="position: absolute; top: 15px; right: 15px; background: #f0f0f0; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 24px; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center;">√ó</button>
                
                <h2 style="margin: 0 0 20px 0; color: #333; font-size: 1.3em; text-align: center;">üîê PIN Sƒ±fƒ±rlama</h2>
                <div style="background: #f9f9f9; border-radius: 12px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <p style="margin: 0; color: #666; font-size: 0.9em;">Doƒürulama kodu, profilinizde kayƒ±tlƒ± telefon numarasƒ±na g√∂nderilecektir.</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <div style="background: #f5f5f5; border: 1px solid #ddd; border-radius: 8px; padding: 10px; font-weight: 600; color: #333; display: flex; align-items: center; justify-content: center; height: 40px;">
                        <input id="profilePhoneInput" type="text" value="+90" autocomplete="off" style="width: 140px; text-align: center; font-size: 1.1em; font-weight: 600; border: none; background: transparent; color: #333; border-radius: 8px; padding: 8px 0; outline: none;" maxlength="13" placeholder="+90 5xx xxx xx xx" oninput="this.value=this.value.replace(/[^\d+]/g,'')" />
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                    <button onclick="requestPinReset('email')" style="padding: 12px; background: #667eea; color: white; border: none; border-radius: 10px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                        ‚úâÔ∏è E-posta
                    </button>
                    <button onclick="requestPinReset('whatsapp')" style="padding: 12px; background: #25D366; color: white; border: none; border-radius: 10px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                        üí¨ WhatsApp
                    </button>
                </div>
                
                <div id="forgotPinStatus" class="status-message" style="display: none;"></div>
            </div>
        </div>

        <!-- Forgot PIN Modal 2: Verify OTP -->
        <div id="verifyOtpModal" class="profile-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: none; align-items: center; justify-content: center;">
            <div style="position: relative; background: white; border-radius: 20px; max-width: 400px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); padding: 25px;">
                <button onclick="closeVerifyOtpModal()" style="position: absolute; top: 15px; right: 15px; background: #f0f0f0; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 24px; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center;">√ó</button>
                
                <!-- SECTION 1: OTP Verification -->
                <div id="otpSection" style="display: block;">
                    <h2 style="margin: 0 0 20px 0; color: #333; font-size: 1.3em; text-align: center;">‚úì Doƒürulama Kodu</h2>
                    
                    <div style="background: #f0f8ff; border-radius: 12px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                        <p style="margin: 0; color: #555; font-size: 0.9em;" id="otpHint">6 haneli kodu girin</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: #666; font-size: 0.9em; margin-bottom: 12px; font-weight: 500; text-align: center;">Doƒürulama Kodunuz (6 Rakam)</label>
                        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; max-width: 280px; margin: 0 auto; margin-bottom: 20px;">
                            <input class="otp-input" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 18px; font-weight: 700; color: #667eea; transition: all 0.3s ease; background: white;" autocomplete="off" />
                            <input class="otp-input" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 18px; font-weight: 700; color: #667eea; transition: all 0.3s ease; background: white;" autocomplete="off" />
                            <input class="otp-input" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 18px; font-weight: 700; color: #667eea; transition: all 0.3s ease; background: white;" autocomplete="off" />
                            <input class="otp-input" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 18px; font-weight: 700; color: #667eea; transition: all 0.3s ease; background: white;" autocomplete="off" />
                            <input class="otp-input" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 18px; font-weight: 700; color: #667eea; transition: all 0.3s ease; background: white;" autocomplete="off" />
                            <input class="otp-input" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 18px; font-weight: 700; color: #667eea; transition: all 0.3s ease; background: white;" autocomplete="off" />
                        </div>
                    </div>
                </div>
                
                <!-- SECTION 2: PIN Setup (shown after verification) -->
                <div id="pinSection" style="display: none;">
                    <h2 style="margin: 0 0 20px 0; color: #333; font-size: 1.3em; text-align: center;">üîë Yeni PIN Belirle</h2>
                    
                    <div style="background: #f0fff4; border-radius: 12px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #27ae60;">
                        <p style="margin: 0; color: #555; font-size: 0.9em;">4 haneli yeni PIN kodunuzu girin</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: #666; font-size: 0.9em; margin-bottom: 12px; font-weight: 500; text-align: center;">Yeni PIN (4 Rakam)</label>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-width: 240px; margin: 0 auto; margin-bottom: 20px;">
                            <input class="new-pin-input" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #27ae60; transition: all 0.3s ease; background: white;" autocomplete="off" />
                            <input class="new-pin-input" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #27ae60; transition: all 0.3s ease; background: white;" autocomplete="off" />
                            <input class="new-pin-input" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #27ae60; transition: all 0.3s ease; background: white;" autocomplete="off" />
                            <input class="new-pin-input" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #27ae60; transition: all 0.3s ease; background: white;" autocomplete="off" />
                        </div>
                    </div>
                </div>
                
                <!-- DYNAMIC BUTTON: Changes based on state -->
                <button id="modalActionBtn" onclick="verifyOtpCode()" style="padding: 12px; width: 100%; background: #667eea; color: white; border: none; border-radius: 10px; font-size: 0.9em; font-weight: 600; cursor: pointer; margin-bottom: 12px;">
                    ‚úì Doƒürula
                </button>
                
                <div id="verifyOtpStatus" class="status-message" style="display: none;"></div>
                
                <!-- NEW PIN SECTION (HIDDEN INITIALLY) -->
                <div id="newPinSection" style="display: none;">
                    <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">
                    <h2 style="margin: 0 0 20px 0; color: #333; font-size: 1.3em; text-align: center;">üîë Yeni PIN Belirle</h2>
                    
                    <div style="background: #f0fff4; border-radius: 12px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #27ae60;">
                        <p style="margin: 0; color: #555; font-size: 0.9em;">Yeni 4 haneli PIN kodunuzu girin</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: #666; font-size: 0.9em; margin-bottom: 12px; font-weight: 500; text-align: center;">Yeni PIN Kodunuz (4 Rakam)</label>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-width: 240px; margin: 0 auto;">
                            <input class="new-pin-input" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #27ae60; transition: all 0.3s ease; background: white;" autocomplete="off" />
                            <input class="new-pin-input" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #27ae60; transition: all 0.3s ease; background: white;" autocomplete="off" />
                            <input class="new-pin-input" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #27ae60; transition: all 0.3s ease; background: white;" autocomplete="off" />
                            <input class="new-pin-input" type="text" maxlength="1" style="width: 100%; aspect-ratio: 1/1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; color: #27ae60; transition: all 0.3s ease; background: white;" autocomplete="off" />
                        </div>
                    </div>
                    
                    <button id="savePinBtn" onclick="confirmNewPin(this)" style="padding: 12px; width: 100%; background: #27ae60; color: white; border: none; border-radius: 10px; font-size: 0.9em; font-weight: 600; cursor: pointer; margin-bottom: 12px;">
                        ‚úì PIN'i Kaydet
                    </button>
                    
                    <div id="newPinStatus" class="status-message" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Forgot PIN Modal 3: Set New PIN -->

        <!-- Sidebar Menu -->
        <div id="groupDetailsModal" class="profile-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: none; align-items: center; justify-content: center; overflow-y: auto; visibility: hidden; opacity: 1;">
            <div style="position: relative; background: white; border-radius: 20px; max-width: 500px; width: 90%; margin: 20px auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); padding: 25px; max-height: 90vh; overflow-y: auto;">
                <button onclick="closeGroupDetailsModal()" style="position: absolute; top: 15px; right: 15px; background: #f0f0f0; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 24px; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; line-height: 1;">√ó</button>
                
                <h2 id="groupDetailTitle" style="margin: 0 0 20px 0; color: #333; font-size: 1.5em; text-align: center;">Grup Detaylarƒ±</h2>
                
                <!-- Grup Bilgileri -->
                <div style="background: #f9f9f9; border-radius: 12px; padding: 15px; border: 1px solid #e0e0e0; margin-bottom: 20px;">
                    <div style="display: flex; flex-direction: column; gap: 0;">
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
                            <span style="color: #666; font-size: 0.9em; font-weight: 500;">üìå Grup Adƒ±</span>
                            <span id="detailGroupName" style="color: #999; font-weight: 600; font-size: 0.9em;">Gri</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
                            <span style="color: #666; font-size: 0.9em; font-weight: 500;">üîë Grup Kodu</span>
                            <span id="detailGroupCode" style="color: #e74c3c; font-weight: 700; font-size: 1.1em; letter-spacing: 1px;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
                            <span style="color: #666; font-size: 0.9em; font-weight: 500;">üè∑Ô∏è Kategori</span>
                            <span id="detailGroupCategory" style="color: #333; font-weight: 600; font-size: 0.9em;">-</span>
                        </div>
                        <div style="display: flex; flex-direction: column; padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="color: #666; font-size: 0.9em; font-weight: 500;">üë• Grup √úyeleri</span>
                                <span id="detailGroupMemberCount" style="color: #999; font-weight: 500; font-size: 0.85em;">-</span>
                            </div>
                            <div id="detailGroupMemberNames" style="display: flex; flex-wrap: wrap; gap: 6px;">
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
                            <span style="color: #666; font-size: 0.9em; font-weight: 500;">üí∞ √ñdeme Dengesi</span>
                            <span id="detailGroupBalance" style="color: #27ae60; font-weight: 700; font-size: 0.95em;">‚Ç∫0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                            <span style="color: #666; font-size: 0.9em; font-weight: 500;">üìÖ Grup Olu≈üturma Tarihi</span>
                            <span id="detailGroupDate" style="color: #333; font-weight: 600; font-size: 0.9em;">-</span>
                        </div>
                    </div>
                </div>

                <!-- Hesap √ñzeti/Sipari≈üler - Opens Modal -->
                <div style="margin-bottom: 20px;">
                    <button onclick="openExpenditureModal()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 0.95em; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                        üí∞ Harcama Detaylarƒ±
                    </button>
                </div>
                
                <!-- Grup Y√∂netim D√ºƒümeleri -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; border-top: 1px solid #e0e0e0; padding-top: 15px;">
                    <button onclick="closeGroupAccount()" style="padding: 12px; background: #9E9E9E; color: white; border: none; border-radius: 10px; font-size: 0.85em; font-weight: 600; cursor: pointer;">
                        üîí Grubu Kapat
                    </button>
                    <button onclick="deleteGroupAccount()" style="padding: 12px; background: #c0392b; color: white; border: none; border-radius: 10px; font-size: 0.85em; font-weight: 600; cursor: pointer;">
                        üóëÔ∏è Grubu Sil
                    </button>
                </div>
            </div>
        </div>

        <!-- Expenditure Details Modal -->
        <div id="expenditureModal" class="modal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); padding: 20px; overflow-y: auto;">
            <div style="background-color: white; border-radius: 15px; width: 100%; max-width: 600px; margin: auto; padding: 0; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); animation: slideUpModal 0.4s ease-out; max-height: 90vh; overflow-y: auto;">
                <!-- Header -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px 20px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10;">
                    <h2 style="margin: 0; color: white; font-size: 1.3em;">üí∞ Harcama Detaylarƒ±</h2>
                    <button onclick="closeExpenditureModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.5em; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; transition: background 0.2s;">
                        ‚úï
                    </button>
                </div>
                
                <!-- Content -->
                <div id="expenditureModalContent" style="padding: 20px; min-height: 200px;">
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 2em; margin-bottom: 10px;">‚è≥</div>
                        <p style="color: #999;">Harcama detaylarƒ± y√ºkleniyor...</p>
                    </div>
                </div>
                
                <!-- Footer -->
                <div style="padding: 15px 20px; border-top: 1px solid #e0e0e0; text-align: center; background: #f9f9f9; border-radius: 0 0 15px 15px;">
                    <button onclick="closeExpenditureModal()" style="padding: 12px 30px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 0.9em; font-weight: 600; cursor: pointer; transition: background 0.2s;">
                        Kapat
                    </button>
                </div>
            </div>
        </div>

        <!-- Men√º Sayfasƒ± -->
        <div id="menuPage" class="page">
            <div class="standard-header">
                <h1>
                    <span class="hesap-word">Hesap</span>
                    <span class="percent-sign">%</span>
                    <span class="paylas-word">Payla≈ü</span>
                </h1>
                <p>t√ºkettiƒüin kadar √∂de !</p>
            </div>
            <div class="back-button" onclick="backToRestaurant()">‚Üê Geri</div>
            
            <div class="logo-card" style="margin: 20px 15px;">
                <h1 style="font-size: 2em; margin: 0 0 8px 0; letter-spacing: 0.5px;">
                    <span style="color: #4A90E2; font-weight: 900;">Hesap</span>
                    <span style="color: #999; font-weight: 400; font-size: 1.2em; margin: 0 8px;">/</span>
                    <span style="color: #9B59B6; font-weight: 900;">Payla≈ü</span>
                </h1>
                <p style="font-size: 0.95em; color: #666; font-style: italic; margin: 12px 0 0 0; font-family: 'Great Vibes', cursive;">hem √ßok kolay, hem √ßok adil !</p>
            </div>
            
            <div class="menu-header">
                <h2 id="restaurantName">Restaurant Adƒ±</h2>
                <p id="restaurantInfo">Telefon: <span id="restaurantPhone"></span></p>
            </div>
            
            <div class="tabs">
                <div id="categoryTabs" class="category-tabs"></div>
            </div>
            
            <div id="menuItems" class="menu-items"></div>
            
            <div class="menu-footer">
                <button class="btn btn-secondary" onclick="goToCart()">üõí Sipari≈ü Listesine Git (Adet: <span id="cartCount">0</span>)</button>
            </div>
        </div>

        <!-- Sipari≈ü Listesi ve Hesap B√∂lme -->
        <div id="cartPage" class="page">
            <div class="standard-header">
                <h1>
                    <span class="hesap-word">Hesap</span>
                    <span class="percent-sign">%</span>
                    <span class="paylas-word">Payla≈ü</span>
                </h1>
                <p>t√ºkettiƒüin kadar √∂de !</p>
            </div>
            <div class="back-button" onclick="backToMenu()">‚Üê Geri</div>
            
            <div class="logo-card" style="margin: 20px 15px;">
                <h1 style="font-size: 2em; margin: 0 0 8px 0; letter-spacing: 0.5px;">
                    <span style="color: #4A90E2; font-weight: 900;">Hesap</span>
                    <span style="color: #999; font-weight: 400; font-size: 1.2em; margin: 0 8px;">/</span>
                    <span style="color: #9B59B6; font-weight: 900;">Payla≈ü</span>
                </h1>
                <p style="font-size: 0.95em; color: #666; font-style: italic; margin: 12px 0 0 0; font-family: 'Great Vibes', cursive;">hem √ßok kolay, hem √ßok adil !</p>
            </div>
            
            <h2>üõí Sipari≈üler ve Hesap B√∂lme</h2>
            
            <div id="ordersSection" class="orders-section">
                <div id="ordersList"></div>
            </div>
            
            <div class="summary-section">
                <div class="summary-card">
                    <h3>üí∞ Toplam Tutarlar</h3>
                    <div id="summaryItems"></div>
                    <hr>
                    <div class="total-row">
                        <strong>Genel Toplam:</strong>
                        <strong id="grandTotal">0.00 ‚Ç∫</strong>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="resetAll()">Yeni Hesaplama</button>
            </div>
        </div>
    </div>

    <!-- Gruba Katƒ±l Modal -->
    <div id="joinGroupModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 90%; width: 100%;">
            <span class="close" onclick="closeJoinGroupModal()">&times;</span>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="margin: 0 0 10px 0; color: #333;">Gruba Katƒ±l</h2>
                <p style="color: #666; margin: 0;">Katƒ±lmak i√ßin Grup kodunu manuel olarak giriniz veya kameranƒ±zla QR kodunu taratƒ±nƒ±z !</p>
            </div>

            <!-- QR Tarama Alanƒ± -->
            <div id="qr-reader" style="width: 100%; border-radius: 10px; overflow: hidden; background: #000; margin-bottom: 15px; border: 2px solid #ddd; display: none;"></div>
            <div id="qr-reader-results" style="text-align: center; color: #666; min-height: 30px; margin-bottom: 15px;"></div>

            <!-- Manuel Kod Girme -->
            <input 
                type="text" 
                id="groupCodeInput" 
                placeholder="Grup kodunu gir (xxx-xxx)" 
                maxlength="7"
                oninput="handleManualCodeInput(this)"
                style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1em; text-align: center; letter-spacing: 2px; margin-bottom: 15px; font-weight: 600; box-sizing: border-box;"
            >

            <!-- Aksiyon D√ºƒümeleri -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="btn btn-primary" id="startScanBtn" onclick="startQRScannerForJoin()" style="flex: 1;">üì± QR kodunu taratmak i√ßin tƒ±klayƒ±n</button>
                <button class="btn btn-primary" id="joinGroupBtn" onclick="joinGroupWithManualCode()" style="flex: 1; display: none;">Gruba Katƒ±l</button>
            </div>
            <button class="btn btn-secondary" id="stopScanBtn" onclick="stopQRScanner()" style="width: 100%; display: none;">üõë Kamerayƒ± Kapat</button>

            <div id="joinGroupMessage" style="text-align: center; margin-top: 15px; min-height: 20px; color: #27ae60; font-weight: 600;"></div>
        </div>
    </div>

    <!-- Yeni Grup Olu≈ütur Modal -->
    <div id="createGroupModal" class="modal" style="display: none; z-index: 10000;">
        <div class="modal-content" style="max-width: 90%; width: 100%; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeCreateGroupModal()">&times;</span>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="margin: 0 0 10px 0; color: #333;" id="modalTitle">Grup Adƒ±nƒ±z</h2>
            </div>

            <!-- Rastgele Renk Adƒ± (Ba≈ülangƒ±√ßta gizli) -->
            <div id="groupNameSection" style="margin-bottom: 15px; text-align: center; display: none;">
                <label style="display: none; margin-bottom: 8px; color: #333; font-weight: 600;">Grup Adƒ±:</label>
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                    <div id="groupColorBox" style="width: 40px; height: 40px; border-radius: 50%; border: 3px solid #ddd; background-color: #FF0000;"></div>
                    <div style="text-align: left;">
                        <div style="font-weight: 600; font-size: 1.1em; color: #333;" id="groupColorName">Kƒ±rmƒ±zƒ±</div>
                    </div>
                </div>
                <input type="hidden" id="newGroupName" value="">
            </div>

            <!-- Kategori Se√ßimi - Butonlar (Ba≈ülangƒ±√ßta gizli) -->
            <div id="categorySection" style="margin-bottom: 15px; display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <button 
                        id="cat-cafe" 
                        onclick="selectCategory('Cafe / Restaurant')" 
                        style="padding: 14px; border: 2px solid #ddd; border-radius: 8px; background: #FFE8B6; cursor: pointer; font-size: 0.75em; transition: all 0.2s; font-weight: 600; text-align: center; min-height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px;"
                    >
<div style="font-size: 2em;">üç¥</div>
Cafe
<br>
Restaurant
                    </button>
                    <button 
                        id="cat-life" 
                        onclick="selectCategory('Genel Ya≈üam')" 
                        style="padding: 14px; border: 2px solid #66BB6A; background: #C8E6C9; border-radius: 8px; cursor: pointer; font-size: 0.75em; transition: all 0.2s; font-weight: 600; text-align: center; min-height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px;"
                    >
<div style="font-size: 2em;">üè†</div>
Genel
<br>
Ya≈üam
                    </button>
                    <button 
                        id="cat-travel" 
                        onclick="selectCategory('Seyahat / Konaklama')" 
                        style="padding: 14px; border: 2px solid #ddd; border-radius: 8px; background: #B3E5FC; cursor: pointer; font-size: 0.75em; transition: all 0.2s; font-weight: 600; text-align: center; min-height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px;"
                    >
<div style="font-size: 2em;">‚úàÔ∏è</div>
Seyahat
<br>
Konaklama
                    </button>
                </div>
                <input type="hidden" id="newGroupCategory" value="Genel Ya≈üam">
            </div>

            <!-- Grup A√ßƒ±klamasƒ± (Opsiyonel) -->
            <div id="descriptionSection" style="margin-bottom: 15px; display: none;">
                <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; text-align: center;">Kƒ±sa A√ßƒ±klama Yazƒ±nƒ±z (Opsiyonel):</label>
                <textarea 
                    id="newGroupDescription" 
                    placeholder="√ñrneƒüin Ak≈üam yemeƒüi, Brunch, Divan veya Develi'de yemek ≈üeklinde belirtebilirsiniz" 
                    style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-family: Arial, sans-serif; font-size: 1em; resize: vertical; min-height: 70px; box-sizing: border-box; transition: border-color 0.2s;"
                    onchange="this.style.borderColor='#ddd'"
                    onfocus="this.style.borderColor='#66BB6A'"
                ></textarea>
                <div style="font-size: 0.85em; color: #999; margin-top: 4px; display: none;">üí° Grup hakkƒ±nda kƒ±sa bir a√ßƒ±klama yazabilirsiniz</div>
            </div>

            <button id="createGroupBtn" class="btn btn-primary" onclick="createNewGroup()" style="width: 100%; margin-bottom: 10px; display: none;">‚úÖ Grubu Kur</button>
            
            <div id="createGroupMessage" style="text-align: center; margin-top: 15px; min-height: 20px; color: #27ae60; font-weight: 600;"></div>
            <!-- Grup Olu≈üturma Ba≈üarƒ±lƒ± - Sonu√ß Ekranƒ± -->
            <div id="groupSuccessSection" style="display: none; text-align: center;">
                <!-- Grup Adƒ± ve Renk Paleti -->
                <div id="successColorSection" style="margin-bottom: 20px; text-align: center;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                        <div id="successColorBox" style="width: 50px; height: 50px; border-radius: 50%; border: 3px solid #ddd; background-color: #FF0000;"></div>
                        <div id="successColorName" style="font-weight: 700; font-size: 1.2em; color: #333;">Kƒ±rmƒ±zƒ±</div>
                    </div>
                    <div id="successColorCode" style="display: none; font-size: 0.9em; color: #666; margin-top: 8px;">#FF0000</div>
                </div>
                
                <!-- QR Kodu -->
                <div style="margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 10px; font-weight: 600;">QR Kodu:</div>
                    <div id="successQRCode" style="display: flex; justify-content: center;">
                        <!-- QR kod buraya yerle≈ütirilecek -->
                    </div>
                </div>
                
                <!-- Grup Kodu -->
                <div style="margin-bottom: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 10px; font-weight: 600;">Grup Kodu:</div>
                    <div id="successGroupCode" style="font-weight: 700; font-size: 1.3em; color: #0066ff; letter-spacing: 2px;">867-765</div>
                </div>
                
                <!-- WhatsApp Payla≈ü Butonu -->
                <button id="whatsappShareBtn" class="btn" onclick="shareGroupOnWhatsapp()" style="width: 100%; background: #25D366; border: none; color: white; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1em;">
                    üì± WhatsApp'ta Payla≈ü
                </button>
            </div>
        </div>
    </div>

    <!-- √úr√ºn Detay Modal -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <p style="text-align: center; font-size: 1.1em; color: #666; font-style: italic; margin: 8px 0 15px 0; font-family: 'Pacifico', 'Brush Script MT', 'Great Vibes', cursive; font-weight: 400;">t√ºkettiƒüin kadar √∂de !</p>
            <span class="close" onclick="closeItemModal()">&times;</span>
            
            <div id="itemModalBody">
                <!-- Dinamik i√ßerik -->
            </div>
        </div>
    </div>

    <!-- Y√ºzen Aktif Grup Buton -->
    <div id="activeGroupButton" style="position: fixed; bottom: 30px; right: 30px; z-index: 999; cursor: pointer; display: none;">
        <button id="activeGroupToggle" onclick="toggleActiveGroupPanel()" style="width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, #00BCD4 0%, #0097A7 100%); border: none; color: white; font-size: 2em; box-shadow: 0 4px 15px rgba(0, 188, 212, 0.4); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
            üë•
        </button>
        <div id="activeGroupPanel" style="display: none; position: absolute; bottom: 90px; right: 0; background: #E0F7FA; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); width: 310px; max-height: 450px; overflow-y: auto; padding: 15px; border: 2px solid #00BCD4;">
            <h3 style="margin: 0 0 15px 0; color: #00897B; font-size: 1.1em; text-align: center; border-bottom: 2px solid #80DEEA; padding-bottom: 10px;">Aktif Gruplarƒ±m</h3>
            <div id="activeGroupsFloatingList" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Gruplar dinamikman JavaScript tarafƒ±ndan y√ºklenir -->
            </div>
        </div>
    </div>

    <!-- Grup √úyeleri Modal -->
    <div id="gruphƒ±zlƒ±eri≈üim" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;">
        <div style="background: white; width: 100%; max-width: 500px; border-radius: 20px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; position: relative;">
            <button onclick="closeGroupMembersModal()" style="position: absolute; top: 15px; right: 15px; background: #f0f0f0; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 24px; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; line-height: 1;">√ó</button>
            <h2 id="memberModalTitle" style="margin: 0 0 20px 0; color: #333; font-size: 1.5em; text-align: center;">Hƒ±zlƒ± ƒ∞≈ülemler</h2>
            <div id="membersList" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- √úyeler buraya dinamikman eklenir -->
            </div>
        </div>
    </div>

    <!-- Gruplarƒ±m Sayfasƒ± - Modal (MOVED OUTSIDE CONTAINER) -->
    <div id="groupsPage" class="profile-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9998; display: none; align-items: center; justify-content: center; overflow-y: auto;">
        <div style="position: relative; background: white; border-radius: 20px; max-width: 500px; width: 90%; margin: 20px auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); padding: 25px;">
            <button onclick="closeGroupsModal()" style="position: absolute; top: 15px; right: 15px; background: #f0f0f0; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 24px; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; line-height: 1;">√ó</button>
            
            <h2 style="margin: 0 0 20px 0; color: #1a237e; font-size: 1.5em; text-align: center;">üë• Gruplarƒ±m</h2>
            
            <!-- Aktif Gruplar -->
            <div style="margin-bottom: 25px;">
                <h3 style="color: #1a237e; margin: 0 0 15px 0; font-size: 1.1em;">üîµ Aktif Gruplar</h3>
                <div id="activeGroupsList" style="display: flex; flex-direction: column; gap: 10px;">
                    <p style="color: #999; text-align: center; padding: 20px;">Y√ºkleniyor...</p>
                </div>
            </div>
            
            <!-- Kapalƒ± Gruplar -->
            <div>
                <h3 style="color: #9E9E9E; margin: 0 0 15px 0; font-size: 1.1em;">‚ö™ Kapalƒ± Gruplar</h3>
                <div id="closedGroupsList" style="display: flex; flex-direction: column; gap: 10px;">
                    <p style="color: #999; text-align: center; padding: 20px;">Y√ºkleniyor...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Libraries - With fallback -->
    <script src="qr-scanner.js?ver=1.0.14"></script>
    
    <script src="script.js?ver=1.0.15"></script>
    
    <script>
        // ===== PHONE LOGIN HOME PAGE FUNCTIONS =====
        
        let isNewUser = false;
        
        // Format phone number input with smart backspace handling
        function formatPhoneInputHome(value) {
            // Only extract digits for formatting
            const digits = value.replace(/\D/g, '');
            
            // Empty input
            if (digits.length === 0) return '';
            
            // Format: (5xx) or (5xx) 3 or (5xx) 333 or (5xx) 333 22 or (5xx) 333 22 22
            if (digits.length <= 3) return `(${digits}`;
            if (digits.length <= 6) return `(${digits.slice(0, 3)}) ${digits.slice(3)}`;
            return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)} ${digits.slice(6, 8)} ${digits.slice(8, 10)}`;
        }

        function formatPhoneForAPI(phone) {
            return phone.replace(/\D/g, '');
        }

        function showMessageHome(message, type = 'info') {
            const msgEl = document.getElementById('statusMessageHome');
            msgEl.textContent = message;
            msgEl.className = `status-message ${type}`;
            if (!message) {
                msgEl.style.display = 'none';
            } else {
                msgEl.style.display = 'block';
            }
        }

        // Phone input listener with smart formatting
        document.getElementById('phoneHome').addEventListener('input', (e) => {
            const oldValue = e.target.value;
            const newValue = formatPhoneInputHome(oldValue);
            if (newValue !== oldValue) {
                e.target.value = newValue;
            }
            // Her input'ta telefonun varlƒ±ƒüƒ± kontrol edilsin, yeni kullanƒ±cƒ± ise alanlar a√ßƒ±lsƒ±n
            checkPhoneAndShowForm();
        });

        // PIN auto-advance functionality
        document.addEventListener('DOMContentLoaded', () => {
            const pinInputsHome = document.querySelectorAll('.pin-input-home');
            pinInputsHome.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    // Only allow digits
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    
                    if (e.target.value.length === 1) {
                        if (index < pinInputsHome.length - 1) {
                            pinInputsHome[index + 1].focus();
                        }
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        pinInputsHome[index - 1].focus();
                    }
                    if (e.key === 'Enter') {
                        submitPhoneForm();
                    }
                });
            });
        });

        // Check phone existence and show appropriate form
        async function checkPhoneAndShowForm() {
            const phoneInput = document.getElementById('phoneHome').value.trim();
            const phone = formatPhoneForAPI(phoneInput);

            console.log('[CHECK-PHONE] phoneInput:', phoneInput, 'formatted:', phone, 'length:', phone.length);

            if (phone.length !== 10) {
                console.log('[CHECK-PHONE] Skipping - phone length is', phone.length, 'need 10');
                return;
            }

            try {
                const API_BASE = window.location.origin;
                const API_BASE_URL = API_BASE + '/api';
                
                console.log('[CHECK-PHONE] Calling API with phone:', phone);
                const response = await fetch(`${API_BASE_URL}/auth/check-phone`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone: phone })
                });

                const data = await response.json();
                console.log('[CHECK-PHONE] API response:', data);

                if (response.ok) {
                    if (data.exists === true) {
                        // Existing user - hide registration fields
                        console.log('[CHECK-PHONE] ‚úì User EXISTS - hiding registration fields and name/email inputs');
                        isNewUser = false;
                        const nameSec = document.getElementById('nameSection');
                        const emailSec = document.getElementById('emailSection');
                        const btnText = document.getElementById('buttonText');
                        if (nameSec) nameSec.style.display = 'none';
                        if (emailSec) emailSec.style.display = 'none';
                        if (btnText) btnText.textContent = 'Giri≈ü Yap';
                        showMessageHome('');
                    } else if (data.exists === false) {
                        // New user - show registration fields and message
                        console.log('[CHECK-PHONE] ‚úó User NOT FOUND - showing registration fields');
                        isNewUser = true;
                        const nameSec = document.getElementById('nameSection');
                        const emailSec = document.getElementById('emailSection');
                        const btnText = document.getElementById('buttonText');
                        const userName = document.getElementById('userName');
                        const userEmail = document.getElementById('userEmail');
                        if (nameSec) nameSec.style.display = 'block';
                        if (emailSec) emailSec.style.display = 'block';
                        if (btnText) btnText.textContent = 'Hesap Olu≈ütur';
                        // Clear any previous values in name and email fields
                        if (userName) userName.value = '';
                        if (userEmail) userEmail.value = '';
                        showMessageHome('Sistemimizde bu Telefon No.su kayƒ±tlƒ± deƒüildir.. Gireceƒüiniz PIN kodu ve diƒüer bilgilerle kaydolunuz', 'info');
                    }
                } else {
                    console.error('[CHECK-PHONE] API error:', response.status);
                    showMessageHome('‚ùå Telefon kontrol√º ba≈üarƒ±sƒ±z', 'error');
                }
            } catch (error) {
                console.error('[CHECK-PHONE] Catch error:', error);
                showMessageHome('‚ùå Bir hata olu≈ütu. L√ºtfen tekrar deneyin.', 'error');
            }
        }

        // Check phone on blur
        document.getElementById('phoneHome').addEventListener('blur', () => {
            const phoneInput = document.getElementById('phoneHome').value.trim();
            if (phoneInput.length >= 14) { // (5xx) 333 22 22
                checkPhoneAndShowForm();
            }
        });

        // Main submit function - handles both login and signup
        async function submitPhoneForm() {
            const phoneInput = document.getElementById('phoneHome').value.trim();
            const phone = formatPhoneForAPI(phoneInput);
            
            // Collect PIN from the 4 boxes
            const pinInputsHome = document.querySelectorAll('.pin-input-home');
            const pin = Array.from(pinInputsHome).map(input => input.value).join('').trim();

            if (phone.length !== 10) {
                showMessageHome('‚ö†Ô∏è Telefon numarasƒ± 10 haneli olmalƒ±dƒ±r', 'error');
                return;
            }

            if (pin.length !== 4 || !/^\d+$/.test(pin)) {
                showMessageHome('‚ö†Ô∏è PIN 4 haneli rakam olmalƒ±dƒ±r', 'error');
                return;
            }

            // Validate registration fields if new user
            if (isNewUser) {
                const name = document.getElementById('userName').value.trim();
                const email = document.getElementById('userEmail').value.trim();

                if (!name || name.length < 2) {
                    showMessageHome('‚ö†Ô∏è Adƒ±nƒ±z en az 2 karakter olmalƒ±dƒ±r', 'error');
                    return;
                }

                if (!email || !email.includes('@')) {
                    showMessageHome('‚ö†Ô∏è Ge√ßerli bir e-posta adresi girin', 'error');
                    return;
                }

                // Ensure phone is just 10 digits (remove leading 90 if present)
                const cleanPhone = phone.length > 10 ? phone.slice(-10) : phone;
                registerNewUser(cleanPhone, pin, name, email);
            } else {
                loginExistingUser(phone, pin);
            }
        }

        // Login existing user
        async function loginExistingUser(phone, pin) {
            const btn = document.querySelector('[onclick="submitPhoneForm()"]');
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'Giri≈ü Yapƒ±lƒ±yor...';

            try {
                const API_BASE = window.location.origin;
                const API_BASE_URL = API_BASE + '/api';
                
                const response = await fetch(`${API_BASE_URL}/auth/phone-pin-login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: phone,
                        pin: pin,
                        is_signup: false
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessageHome('‚úÖ Ba≈üarƒ±yla giri≈ü yaptƒ±nƒ±z!', 'success');
                    localStorage.setItem('hesapPaylas_token', data.token);
                    localStorage.setItem('hesapPaylas_user', JSON.stringify(data.user));
                    // Switch to home page - it will load groups automatically via showPage()
                    setTimeout(() => {
                        showPage('homePage');
                        // Reset button state
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }, 800);
                } else {
                    showMessageHome('‚ùå Hatalƒ± PIN...Tekrar deneyin veya hatƒ±rlatma kodu isteyin', 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                    // Clear PIN boxes
                    document.querySelectorAll('.pin-input-home').forEach(input => input.value = '');
                    document.querySelector('.pin-input-home').focus();
                }
            } catch (error) {
                console.error('Error:', error);
                showMessageHome('‚ùå Bir hata olu≈ütu. L√ºtfen tekrar deneyin.', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Register new user
        async function registerNewUser(phone, pin, name, email) {
            const btn = document.querySelector('[onclick="submitPhoneForm()"]');
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'Hesap Olu≈üturuluyor...';

            try {
                const API_BASE = window.location.origin;
                const API_BASE_URL = API_BASE + '/api';
                
                const payload = {
                    phone: phone,
                    pin: pin,
                    is_signup: true,
                    first_name: name.split(' ')[0],
                    last_name: name.includes(' ') ? name.split(' ').slice(1).join(' ') : '',
                    email: email
                };
                
                console.log('[REGISTER] Payload:', payload);
                
                const response = await fetch(`${API_BASE_URL}/auth/phone-pin-login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                console.log('[REGISTER] Response status:', response.status, 'Data:', data);

                if (response.ok) {
                    showMessageHome('‚úÖ Hesap olu≈üturuldu! Giri≈ü yapƒ±lƒ±yor...', 'success');
                    localStorage.setItem('hesapPaylas_token', data.token);
                    localStorage.setItem('hesapPaylas_user', JSON.stringify(data.user));
                    
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                } else {
                    console.log('[REGISTER] Error response:', data);
                    showMessageHome('‚ùå ' + (data.error || data.debug || 'Hesap olu≈üturulamadƒ±'), 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (error) {
                console.error('[REGISTER] Catch error:', error);
                showMessageHome('‚ùå Bir hata olu≈ütu. L√ºtfen tekrar deneyin.', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // ===== PIN RESET FUNCTIONS (Scenario 3) =====

        let pinResetPhone = '';
        let pinResetEmail = '';
        let pinResetMethod = '';
        let pinResetOtpVerified = false;

        function openForgotPinModal() {
            document.getElementById('forgotPinModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            // Always get latest profile phone from API/localStorage
            var phone = '';
            if (window.api && typeof api.getProfile === 'function') {
                api.getProfile().then(function(profile) {
                    if (profile && profile.phone) {
                        app.currentUser = app.currentUser || {};
                        app.currentUser.phone = profile.phone;
                        localStorage.setItem('hesapPaylas_user', JSON.stringify(profile));
                        phone = profile.phone;
                    } else {
                        phone = '';
                    }
                    var input = document.getElementById('profilePhoneInput');
                    if (input) {
                        input.value = phone && phone.length >= 10 ? ('+90' + phone.replace(/^\+?90/, '')) : '+90';
                    }
                }).catch(function() {
                    // fallback to localStorage
                    var user = localStorage.getItem('hesapPaylas_user');
                    if (user) {
                        try {
                            var parsed = JSON.parse(user);
                            phone = parsed.phone || '';
                        } catch (e) { phone = ''; }
                    }
                    app.currentUser = app.currentUser || {};
                    app.currentUser.phone = phone;
                    var input = document.getElementById('profilePhoneInput');
                    if (input) {
                        input.value = phone && phone.length >= 10 ? ('+90' + phone.replace(/^\+?90/, '')) : '+90';
                    }
                });
            } else {
                var user = localStorage.getItem('hesapPaylas_user');
                if (user) {
                    try {
                        var parsed = JSON.parse(user);
                        phone = parsed.phone || '';
                    } catch (e) { phone = ''; }
                }
                app.currentUser = app.currentUser || {};
                app.currentUser.phone = phone;
                var input = document.getElementById('profilePhoneInput');
                if (input) {
                    input.value = phone && phone.length >= 10 ? ('+90' + phone.replace(/^\+?90/, '')) : '+90';
                }
            }
        }

        function closeForgotPinModal() {
            document.getElementById('forgotPinModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('forgotPinStatus').style.display = 'none';
        }

        function closeVerifyOtpModal() {
            document.getElementById('verifyOtpModal').style.display = 'none';
            // Don't set overflow - let newPinModal control it
            document.querySelectorAll('.otp-input').forEach(input => input.value = '');
            document.getElementById('verifyOtpStatus').style.display = 'none';
        }

        function closeNewPinModal() {
            document.getElementById('newPinModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.querySelectorAll('.new-pin-input').forEach(input => input.value = '');
            document.getElementById('newPinStatus').style.display = 'none';
        }

        // OTP input auto-advance for verification
        document.addEventListener('DOMContentLoaded', () => {
            const otpInputs = document.querySelectorAll('.otp-input');
            otpInputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    if (e.target.value.length === 1) {
                        if (index < otpInputs.length - 1) {
                            otpInputs[index + 1].focus();
                        }
                    }
                });
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        otpInputs[index - 1].focus();
                    }
                });
            });

            // New PIN input auto-advance
            const newPinInputs = document.querySelectorAll('.new-pin-input');
            newPinInputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    if (e.target.value.length === 1) {
                        if (index < newPinInputs.length - 1) {
                            newPinInputs[index + 1].focus();
                        }
                    }
                });
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        newPinInputs[index - 1].focus();
                    }
                    if (e.key === 'Enter') {
                        confirmNewPin();
                    }
                });
            });

            // Format phone in forgot PIN form
            const forgotPinPhoneInput = document.getElementById('forgotPinPhone');

        });

        function showOtpStatus(message, type = 'info') {
            const el = document.getElementById('verifyOtpStatus');
            el.textContent = message;
            el.className = `status-message ${type}`;
            el.style.display = 'block';
        }

        function showNewPinStatus(message, type = 'info') {
            const el = document.getElementById('newPinStatus');
            el.textContent = message;
            el.className = `status-message ${type}`;
            el.style.display = 'block';
        }

        async function requestPinReset(method) {
                    // NOTE: Replace whatsappNumber below with your WhatsApp bot number (in international format, e.g. 905555555555)

            // Use phone from input (editable)
            const phoneInput = document.getElementById('profilePhoneInput');
            let phone = phoneInput.value.replace(/\D/g, '');
            const statusEl = document.getElementById('forgotPinStatus');

            // If phone is missing or not 10/11 digits, show info message and do not show error
            if (!phone || (phone.length !== 10 && phone.length !== 11)) {
                statusEl.textContent = 'L√ºtfen ge√ßerli bir telefon numarasƒ± girin (√∂rn: 5xx xxx xx xx).';
                statusEl.className = 'status-message info';
                statusEl.style.display = 'block';
                return;
            }

            // Always use last 10 digits for Turkish numbers
            if (phone.length === 11 && phone.startsWith('90')) {
                phone = phone.slice(1);
            } else if (phone.length > 10) {
                phone = phone.slice(-10);
            }

            pinResetPhone = phone;
            pinResetMethod = method;
            pinResetOtpVerified = false;

            try {
                const API_BASE = window.location.origin;
                const API_BASE_URL = API_BASE + '/api';

                const response = await fetch(`${API_BASE_URL}/auth/request-pin-reset-both`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: phone
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Capture email and phone from response
                    pinResetEmail = data.email || data.email_hint || '';
                    console.log('[DEBUG] PIN reset request response received');
                    console.log('[DEBUG] Response data:', data);
                    console.log('[DEBUG] pinResetEmail set to:', pinResetEmail);
                    statusEl.textContent = `‚úÖ Doƒürulama kodunu e-posta adresine g√∂nderdik: ${pinResetEmail}`;
                    statusEl.className = 'status-message success';
                    statusEl.style.display = 'block';
                    setTimeout(() => {
                        closeForgotPinModal();
                        document.getElementById('verifyOtpModal').style.display = 'flex';
                        document.body.style.overflow = 'hidden';
                        document.querySelector('.otp-input').focus();
                    }, 2000);
                } else {
                    statusEl.textContent = '‚ùå ' + (data.message || data.error || 'Hata olu≈ütu');
                    statusEl.className = 'status-message error';
                    statusEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                statusEl.textContent = '‚ùå Bir hata olu≈ütu. L√ºtfen tekrar deneyin.';
                statusEl.className = 'status-message error';
                statusEl.style.display = 'block';
            }
        }

        async function verifyOtpCode() {
            const otpInputs = document.querySelectorAll('.otp-input');
            const otp = Array.from(otpInputs).map(input => input.value).join('').trim();

            if (otp.length !== 6 || !/^\d+$/.test(otp)) {
                showOtpStatus('‚ö†Ô∏è Kod 6 haneli olmalƒ±dƒ±r', 'error');
                return;
            }

            try {
                const API_BASE = window.location.origin;
                const API_BASE_URL = API_BASE + '/api';
                // Always send phone in +90 format
                let phoneToSend = pinResetPhone;
                if (!phoneToSend.startsWith('+')) {
                    phoneToSend = '+90' + phoneToSend.replace(/^0+/, '');
                }
                const response = await fetch(`${API_BASE_URL}/auth/verify-pin-reset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: phoneToSend,
                        code: otp
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    console.log('[DEBUG] OTP verification successful');
                    console.log('[DEBUG] pinResetEmail:', pinResetEmail);
                    showOtpStatus('‚úÖ Kod doƒürulandƒ±!', 'success');
                    pinResetOtpVerified = true;
                    console.log('[DEBUG] pinResetOtpVerified set to true');
                    
                    // Hide OTP input section and show PIN section
                    setTimeout(() => {
                        // Hide all OTP inputs and their label
                        const modal = document.getElementById('verifyOtpModal');
                        if (modal) {
                            // Hide OTP div with inputs
                            const otpDiv = modal.querySelector('div:has(.otp-input)');
                            if (otpDiv && otpDiv.parentElement) {
                                otpDiv.parentElement.style.display = 'none';
                            }
                            // Hide verify button
                            const buttons = modal.querySelectorAll('button');
                            for (let btn of buttons) {
                                if (btn.textContent.includes('Doƒürula')) {
                                    btn.style.display = 'none';
                                }
                            }
                        }
                        
                        // Show new PIN section
                        const newPinSection = document.getElementById('newPinSection');
                        console.log('[DEBUG] newPinSection:', newPinSection);
                        if (newPinSection) {
                            newPinSection.style.display = 'block';
                            // Focus first PIN input
                            const firstInput = newPinSection.querySelector('.new-pin-input');
                            console.log('[DEBUG] Focusing first input:', firstInput);
                            if (firstInput) firstInput.focus();
                        }
                    }, 800);
                } else {
                    showOtpStatus('‚ùå ' + (data.error || 'Kod yanlƒ±≈ü veya s√ºresi doldu'), 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showOtpStatus('‚ùå Bir hata olu≈ütu. L√ºtfen tekrar deneyin.', 'error');
            }
        }

        async function confirmNewPin(btn) {
            const newPinInputs = document.querySelectorAll('.new-pin-input');
            const newPin = Array.from(newPinInputs).map(input => input.value).join('').trim();

            if (newPin.length !== 4 || !/^\d+$/.test(newPin)) {
                showNewPinStatus('‚ö†Ô∏è PIN 4 haneli olmalƒ±dƒ±r', 'error');
                return;
            }

            if (!pinResetOtpVerified) {
                showNewPinStatus('‚ùå L√ºtfen √∂nce doƒürulama kodunu girin', 'error');
                return;
            }

            if (!btn) btn = document.getElementById('savePinBtn');
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'PIN Kaydediliyor...';

            try {
                const API_BASE = window.location.origin;
                const API_BASE_URL = API_BASE + '/api';
                // Always send phone in +90 format
                let phoneToSend = pinResetPhone;
                if (!phoneToSend.startsWith('+')) {
                    phoneToSend = '+90' + phoneToSend.replace(/^0+/, '');
                }
                
                console.log('[DEBUG] confirmNewPin called');
                console.log('[DEBUG] phoneToSend:', phoneToSend);
                console.log('[DEBUG] pinResetEmail:', pinResetEmail);
                console.log('[DEBUG] newPin:', newPin);
                console.log('[DEBUG] pinResetOtpVerified:', pinResetOtpVerified);
                
                // Only allow PIN reset if OTP was verified
                if (!pinResetOtpVerified) {
                    showNewPinStatus('‚ùå L√ºtfen √∂nce doƒürulama kodunu girin', 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                    return;
                }
                
                const payload = {
                    phone: phoneToSend,
                    email: pinResetEmail || document.getElementById('emailForReset')?.value || '',
                    new_pin: newPin
                };
                
                console.log('[DEBUG] Sending payload:', payload);
                
                const response = await fetch(`${API_BASE_URL}/auth/reset-pin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                
                console.log('[DEBUG] Response status:', response.status);
                console.log('[DEBUG] Response data:', data);
                
                if (response.ok) {
                    showNewPinStatus('‚úÖ PIN ba≈üarƒ±yla sƒ±fƒ±rlandƒ±! Giri≈ü yapƒ±lƒ±yor...', 'success');
                    // Reset state
                    pinResetPhone = '';
                    pinResetEmail = '';
                    pinResetMethod = '';
                    pinResetOtpVerified = false;
                    // Close modal and redirect to login after 2 seconds
                    setTimeout(() => {
                        closeNewPinModal();
                        // Show login form
                        document.getElementById('phoneHome').value = '';
                        document.querySelectorAll('.pin-input-home').forEach(input => input.value = '');
                        document.getElementById('statusMessageHome').textContent = '';
                        document.querySelector('.pin-input-home').focus();
                    }, 2000);
                } else {
                    showNewPinStatus('‚ùå ' + (data.error || 'PIN sƒ±fƒ±rlama ba≈üarƒ±sƒ±z'), 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (error) {
                console.error('Error:', error);
                showNewPinStatus('‚ùå Bir hata olu≈ütu. L√ºtfen tekrar deneyin.', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
    </script>
</body>
</html>
